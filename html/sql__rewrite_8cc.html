<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MySQL: sql/sql_rewrite.cc File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="mysql.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo-mysql-110x55.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MySQL
   &#160;<span id="projectnumber">8.0.22</span>
   </div>
   <div id="projectbrief">Source Code Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('sql__rewrite_8cc.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">sql_rewrite.cc File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="sql__rewrite_8h_source.html">sql/sql_rewrite.h</a>&quot;</code><br />
<code>#include &lt;stdio.h&gt;</code><br />
<code>#include &lt;<a class="el" href="string_8h_source.html">string.h</a>&gt;</code><br />
<code>#include &lt;sys/types.h&gt;</code><br />
<code>#include &lt;algorithm&gt;</code><br />
<code>#include &lt;memory&gt;</code><br />
<code>#include &lt;set&gt;</code><br />
<code>#include &lt;string&gt;</code><br />
<code>#include &quot;<a class="el" href="lex__string_8h_source.html">lex_string.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="m__ctype_8h_source.html">m_ctype.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="m__string_8h_source.html">m_string.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="my__compiler_8h_source.html">my_compiler.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="my__dbug_8h_source.html">my_dbug.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="my__inttypes_8h_source.html">my_inttypes.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="prealloced__array_8h_source.html">prealloced_array.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="auth__acls_8h_source.html">sql/auth/auth_acls.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="auth__common_8h_source.html">sql/auth/auth_common.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="sql_2handler_8h_source.html">sql/handler.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="log__event_8h_source.html">sql/log_event.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="rpl__slave_8h_source.html">sql/rpl_slave.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="set__var_8h_source.html">sql/set_var.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="sql__admin_8h_source.html">sql/sql_admin.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="sql__class_8h_source.html">sql/sql_class.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="sql__connect_8h_source.html">sql/sql_connect.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="sql__lex_8h_source.html">sql/sql_lex.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="sql__list_8h_source.html">sql/sql_list.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="sql__parse_8h_source.html">sql/sql_parse.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="sql__servers_8h_source.html">sql/sql_servers.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="sql__show_8h_source.html">sql/sql_show.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="sql_2table_8h_source.html">sql/table.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="sql__string_8h_source.html">sql_string.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="violite_8h_source.html">violite.h</a>&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a5df996f0683795f0b60c5111c02aeb8c"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sql__rewrite_8cc.html#a5df996f0683795f0b60c5111c02aeb8c">HASH_STRING_WITH_QUOTE</a>&#160;&#160;&#160;&quot;$5$BVZy9O&gt;'a+2MH]_?$fpWyabcdiHjfCVqId/quykZzjaA7adpkcen/uiQrtmOK4p4&quot;</td></tr>
<tr class="memdesc:a5df996f0683795f0b60c5111c02aeb8c"><td class="mdescLeft">&#160;</td><td class="mdescRight">In here, we rewrite queries.  <a href="#a5df996f0683795f0b60c5111c02aeb8c">More...</a><br /></td></tr>
<tr class="separator:a5df996f0683795f0b60c5111c02aeb8c"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a98b3fe147180d5b4824bd5c4a22f4198"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sql__rewrite_8cc.html#a98b3fe147180d5b4824bd5c4a22f4198">mysql_rewrite_query</a> (<a class="el" href="classTHD.html">THD</a> *thd, <a class="el" href="sql__rewrite_8h.html#aedd3cc5066a5809fc618e9e8ca87b7a2">Consumer_type</a> type, <a class="el" href="classRewrite__params.html">Rewrite_params</a> *params)</td></tr>
<tr class="memdesc:a98b3fe147180d5b4824bd5c4a22f4198"><td class="mdescLeft">&#160;</td><td class="mdescRight">Provides the default interface to rewrite the SQL statements to to obfuscate passwords.  <a href="#a98b3fe147180d5b4824bd5c4a22f4198">More...</a><br /></td></tr>
<tr class="separator:a98b3fe147180d5b4824bd5c4a22f4198"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aef26a9d429a1f3de6e8350843a2b9c52"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sql__rewrite_8cc.html#aef26a9d429a1f3de6e8350843a2b9c52">mysql_rewrite_acl_query</a> (<a class="el" href="classTHD.html">THD</a> *thd, <a class="el" href="classString.html">String</a> &amp;rlb, <a class="el" href="sql__rewrite_8h.html#aedd3cc5066a5809fc618e9e8ca87b7a2">Consumer_type</a> type, <a class="el" href="classRewrite__params.html">Rewrite_params</a> *params, <a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a> do_ps_instrument)</td></tr>
<tr class="memdesc:aef26a9d429a1f3de6e8350843a2b9c52"><td class="mdescLeft">&#160;</td><td class="mdescRight">Provides the default interface to rewrite the ACL query.  <a href="#aef26a9d429a1f3de6e8350843a2b9c52">More...</a><br /></td></tr>
<tr class="separator:aef26a9d429a1f3de6e8350843a2b9c52"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a id="a5df996f0683795f0b60c5111c02aeb8c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5df996f0683795f0b60c5111c02aeb8c">&#9670;&nbsp;</a></span>HASH_STRING_WITH_QUOTE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define HASH_STRING_WITH_QUOTE&#160;&#160;&#160;&quot;$5$BVZy9O&gt;'a+2MH]_?$fpWyabcdiHjfCVqId/quykZzjaA7adpkcen/uiQrtmOK4p4&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>In here, we rewrite queries. </p>
<p>For now, this is only used to obfuscate passwords before we log a statement. If we ever get other clients for rewriting, we should introduce a rewrite_flags to determine what kind of rewriting (password obfuscation etc.) is desired by the client.</p>
<p>Some items in the server can self-print anyway, but many can't.</p>
<p>For instance, you'll see a re-synthesized SELECT in EXPLAIN EXTENDED, but you won't get a resynthized query in EXPLAIN EXTENDED if you were explaining an UPDATE.</p>
<p>The following does not claim to be able to re-synthesize every statement, but attempts to ultimately be able to resynthesize all statements that have need of rewriting.</p>
<p>Stored procedures may also rewrite their statements (to show the actual values of their variables etc.). There is currently no scenario where a statement can be eligible for both rewrites (see sp_instr.cc). Special consideration will need to be taken if this is intenionally changed at a later date. (There is an ASSERT() in place that will hopefully catch unintentional changes.)</p>
<p>Finally, sp_* have code to print a stored program for use by SHOW PROCEDURE CODE / SHOW FUNCTION CODE.</p>
<p>Thus, regular query parsing comes through here for logging. So does prepared statement logging. Stored instructions of the sp_instr_stmt type (which should be the only ones to contain passwords, and therefore at this time be eligible for rewriting) go through the regular parsing facilities and therefore also come through here for logging (other sp_instr_* types don't).</p>
<p>Finally, as rewriting goes, by default we replace the password with a literal &lt;secret&gt;, with <em>no</em> quotation marks so the statement would fail if the user were to cut &amp; paste it without filling in the real password. This default behavior is ON for rewriting to the textual logs. For instance : General, slow query and audit log. Rewriters also have a provision to replace the password with its hash where we have the latter. (so they could be replayed, IDENTIFIED WITH &lt;plugin_name&gt; AS &lt;hash&gt;); This hash is needed while writing the statements for binlog. </p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="aef26a9d429a1f3de6e8350843a2b9c52"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aef26a9d429a1f3de6e8350843a2b9c52">&#9670;&nbsp;</a></span>mysql_rewrite_acl_query()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void mysql_rewrite_acl_query </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classTHD.html">THD</a> *&#160;</td>
          <td class="paramname"><em>thd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classString.html">String</a> &amp;&#160;</td>
          <td class="paramname"><em>rlb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="sql__rewrite_8h.html#aedd3cc5066a5809fc618e9e8ca87b7a2">Consumer_type</a>&#160;</td>
          <td class="paramname"><em>type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classRewrite__params.html">Rewrite_params</a> *&#160;</td>
          <td class="paramname"><em>params</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a>&#160;</td>
          <td class="paramname"><em>do_ps_instrument</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Provides the default interface to rewrite the ACL query. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">thd</td><td>The THD to rewrite for. </td></tr>
    <tr><td class="paramname">rlb</td><td>Buffer to return rewritten query in (if any) if do_ps_instrument is false. </td></tr>
    <tr><td class="paramname">type</td><td>Purpose of rewriting the query Consumer_type::LOG To rewrite the query either for general, slow query and audit log. Consumer_type::BINLOG To rewrite the query for binlogs. Consumer_type::CONSOLE To rewrite the query for standard output. </td></tr>
    <tr><td class="paramname">params</td><td>Wrapper object of parameters in case needed by a SQL rewriter. </td></tr>
    <tr><td class="paramname">do_ps_instrument</td><td>flag to indicate if the query has to be instrumented in the PSI. Default value is true. If instrumented, the previous </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a98b3fe147180d5b4824bd5c4a22f4198"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a98b3fe147180d5b4824bd5c4a22f4198">&#9670;&nbsp;</a></span>mysql_rewrite_query()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void mysql_rewrite_query </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classTHD.html">THD</a> *&#160;</td>
          <td class="paramname"><em>thd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="sql__rewrite_8h.html#aedd3cc5066a5809fc618e9e8ca87b7a2">Consumer_type</a>&#160;</td>
          <td class="paramname"><em>type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classRewrite__params.html">Rewrite_params</a> *&#160;</td>
          <td class="paramname"><em>params</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Provides the default interface to rewrite the SQL statements to to obfuscate passwords. </p>
<p>The query aimed to be rewritten in the usual log files (i.e. General, slow query and audit log) uses default value of type which is Consumer_type::LOG</p>
<p>Side-effects:</p>
<ul>
<li>thd-&gt;m_rewritten_query will contain a rewritten query, or be cleared if no rewriting took place. LOCK_thd_query will be temporarily acquired to make that change.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>Keep in mind that these side-effects will only happen when calling this top-level function, but not when calling individual sub-functions directly!</dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">thd</td><td>The THD to rewrite for. </td></tr>
    <tr><td class="paramname">type</td><td>Purpose of rewriting the query Consumer_type::LOG To rewrite the query either for general, slow query and audit log. Consumer_type::BINLOG To rewrite the query for binlogs. Consumer_type::CONSOLE To rewrite the query for standard output. </td></tr>
    <tr><td class="paramname">params</td><td>Wrapper object of parameters in case needed by a SQL rewriter. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_5bd71961b401a432086d0fb290a87f3f.html">sql</a></li><li class="navelem"><a class="el" href="sql__rewrite_8cc.html">sql_rewrite.cc</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
