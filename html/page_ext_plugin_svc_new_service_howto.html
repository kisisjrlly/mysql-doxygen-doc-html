<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MySQL: How to add a new service</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="mysql.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo-mysql-110x55.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MySQL
   &#160;<span id="projectnumber">8.0.22</span>
   </div>
   <div id="projectbrief">Source Code Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('page_ext_plugin_svc_new_service_howto.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">How to add a new service </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>A "plugin service" is in its core a C struct containing one or more function pointers.</p>
<p>If you want to export C++ class you need to provide an extern "C" function that will create a new instance of your class, and put it in a service. But be careful to also provide a destructor method since the heaps of the server and the plugin may be different.</p>
<p>Data structures are not part of the service structure, but they are part of the API you create and usually need to be declared in the same service_*.h file.</p>
<p>To turn a <b>pre-existing</b> set of functions (foo_func1, foo_func2) into a service "foo" you need to:</p>
<ol>
<li>
<p class="startli">Create a new file include/mysql/service_foo.h</p>
<p>The template is:</p>
<div class="fragment"><div class="line"><span class="comment">/* Copyright (c) 2016, Oracle and/or its affiliates. All rights reserved.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">This program is free software; you can redistribute it and/or modify</span></div><div class="line"><span class="comment">it under the terms of the GNU General Public License, version 2.0,</span></div><div class="line"><span class="comment">as published by the Free Software Foundation.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">This program is also distributed with certain software (including</span></div><div class="line"><span class="comment">but not limited to OpenSSL) that is licensed under separate terms,</span></div><div class="line"><span class="comment">as designated in a particular file or component or in included license</span></div><div class="line"><span class="comment">documentation.  The authors of MySQL hereby grant you an additional</span></div><div class="line"><span class="comment">permission to link the program and your derivative works with the</span></div><div class="line"><span class="comment">separately licensed software that they have included with MySQL.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">This program is distributed in the hope that it will be useful,</span></div><div class="line"><span class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div><div class="line"><span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div><div class="line"><span class="comment">GNU General Public License, version 2.0, for more details.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">You should have received a copy of the GNU General Public License</span></div><div class="line"><span class="comment">along with this program; if not, write to the Free Software</span></div><div class="line"><span class="comment">Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301  USA */</span></div><div class="line"></div><div class="line"><span class="preprocessor">#ifndef MYSQL_SERVICE_FOO_INCLUDED</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">  @file</span></div><div class="line"><span class="comment">  TODO: Fill in a description of your file here.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="preprocessor">#ifdef __cplusplus</span></div><div class="line"><span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> {</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">  @ingroup group_ext_plugin_services</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">  TODO: Fill in the architecture of your service.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">  This is the primary documentation of your new service</span></div><div class="line"><span class="comment">  and will be auto-added to the service description document</span></div><div class="line"><span class="comment">  because of it being a part of the doxygen group</span></div><div class="line"><span class="comment">  group_ext_plugin_services.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">extern</span> <span class="keyword">struct </span>foo_service_st {<span class="comment"></span></div><div class="line"><span class="comment">  /**</span></div><div class="line"><span class="comment">    TODO: Interface description of foo_func1_type.</span></div><div class="line"><span class="comment">    Fix the prototype as appropriate.</span></div><div class="line"><span class="comment">    You can add a see-also to the implementation too.</span></div><div class="line"><span class="comment">  */</span></div><div class="line">  int (*foo_func1_type)(...);<span class="comment"></span></div><div class="line"><span class="comment">  /**</span></div><div class="line"><span class="comment">    TODO: Interface description of foo_func2_type.</span></div><div class="line"><span class="comment">    Fix the prototype as appropriate.</span></div><div class="line"><span class="comment">    You can add a see-also to the implementation too.</span></div><div class="line"><span class="comment">  */</span></div><div class="line">  void (*foo_func2_type)(...);</div><div class="line">} * foo_service;</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef MYSQL_DYNAMIC_PLUGIN</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define foo_func1(...) foo_service-&gt;foo_func1_type(...)</span></div><div class="line"><span class="preprocessor">#define foo_func2(...) foo_service-&gt;foo_func2_type(...)</span></div><div class="line"></div><div class="line"><span class="preprocessor">#else</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> foo_func1_type(...);  <span class="comment">/** TODO: fix the prototype as appropriate */</span></div><div class="line"><span class="keywordtype">void</span> foo_func2_type(...); <span class="comment">/** TODO: fix the prototype as appropriate */</span></div><div class="line"></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef __cplusplus</span></div><div class="line">}</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define MYSQL_SERVICE_FOO_INCLUDED</span></div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --><p>The service_foo.h file should be self-contained, if it needs system headers - include them in it, e.g. if you use <code>size_t</code></p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div></div><!-- fragment --><p class="endli">It should also declare all the accompanying data structures, as necessary (e.g. thd_alloc_service declares MYSQL_LEX_STRING). </p>
</li>
<li>
Add the new file to include/mysql/services.h </li>
<li>
Increase the minor plugin ABI version in include/mysql/plugin.h: MYSQL_PLUGIN_INTERFACE_VERSION = MYSQL_PLUGIN_INTERFACE_VERSION + 1 </li>
<li>
Add the version of your service to include/service_versions.h: <div class="fragment"><div class="line"><span class="preprocessor">#define VERSION_foo 0x0100</span></div></div><!-- fragment --> </li>
<li>
Create a new file <code>libservices/foo_service.c</code> using the following template: <div class="fragment"><div class="line"><span class="comment">/* Copyright (c) 2016, 2017, Oracle and/or its affiliates. All rights reserved.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">This program is free software; you can redistribute it and/or modify</span></div><div class="line"><span class="comment">it under the terms of the GNU General Public License, version 2.0,</span></div><div class="line"><span class="comment">as published by the Free Software Foundation.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">This program is also distributed with certain software (including</span></div><div class="line"><span class="comment">but not limited to OpenSSL) that is licensed under separate terms,</span></div><div class="line"><span class="comment">as designated in a particular file or component or in included license</span></div><div class="line"><span class="comment">documentation.  The authors of MySQL hereby grant you an additional</span></div><div class="line"><span class="comment">permission to link the program and your derivative works with the</span></div><div class="line"><span class="comment">separately licensed software that they have included with MySQL.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">This program is distributed in the hope that it will be useful,</span></div><div class="line"><span class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div><div class="line"><span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div><div class="line"><span class="comment">GNU General Public License, version 2.0, for more details.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">You should have received a copy of the GNU General Public License</span></div><div class="line"><span class="comment">along with this program; if not, write to the Free Software</span></div><div class="line"><span class="comment">Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301  USA */</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="service__versions_8h.html">service_versions.h</a>&gt;</span></div><div class="line"><a class="code" href="service__versions_8h.html#affcee91a740a7f12936bd4da2c60bbb8">SERVICE_VERSION</a> *foo_service = (<span class="keywordtype">void</span> *)VERSION_foo;</div></div><!-- fragment --> </li>
<li>
Add the new file to libservices/CMakeLists.txt (MYSQLSERVICES_SOURCES) </li>
<li>
And finally, register your service for dynamic linking in sql/sql_plugin_services.h <ul>
<li>
Fill in the service structure: <div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>foo_service_st foo_handler = {</div><div class="line">  foo_func1,</div><div class="line">  foo_func2</div><div class="line">}</div></div><!-- fragment --> </li>
<li>
<p class="startli">Add it to the list_of_services</p>
<div class="fragment"><div class="line">{ <span class="stringliteral">&quot;foo_service&quot;</span>, VERSION_foo, &amp;foo_handler }</div></div><!-- fragment --> </li>
</ul>
</li>
</ol>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="PAGE_EXTENDING.html">Extending MySQL</a></li><li class="navelem"><a class="el" href="page_ext_plugin_services.html">Plugin Services</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
