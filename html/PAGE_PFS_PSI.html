<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MySQL: Instrumentation interface</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="mysql.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo-mysql-110x55.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MySQL
   &#160;<span id="projectnumber">8.0.22</span>
   </div>
   <div id="projectbrief">Source Code Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('PAGE_PFS_PSI.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Instrumentation interface </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>MySQL performance schema instrumentation interface.</p>
<h1><a class="anchor" id="PFS_PSI_INTRO"></a>
Introduction</h1>
<p>Any code can be instrumented with the performance schema, regardless of the kind of code used:</p><ul>
<li>code within the server implementation itself</li>
<li>code within various plugins, including storage engines, compiled and delivered with the server (aka, static plugins)</li>
<li>code within various plugins, including storage engines, compiled and delivered separately from the server (aka, dynamic plugins)</li>
<li>code from components, either provided by MySQL or by third parties, compiled and delivered separately (and loaded dynamically).</li>
</ul>
<p>The instrumentation interface consist of two layers:</p><ul>
<li>a raw ABI (Application Binary Interface) layer, that exposes the primitive instrumentation functions exported by the performance schema instrumentation</li>
<li>an API (Application Programing Interface) layer, that provides many helpers for a developer instrumenting some code, to make the instrumentation as easy as possible.</li>
</ul>
<p>In each case, the API may expand into different code paths, and use different ABI infrastructure, depending on how the code is built. In each case, the API exposed is consistent: instrumented source code is the same, regardless of where it is built.</p>
<p>The following sections details what happens technically for each type of code. The same instrumentation (a mutex) is used, to illustrate.</p>
<h1><a class="anchor" id="PFS_PSI_NONE"></a>
Non instrumented code</h1>
<p>Assume some existing code using a mutex, for example for linux</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;pthread.h&gt;</span></div><div class="line"></div><div class="line">pthread_mutex_t foo;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> do_something()</div><div class="line">{</div><div class="line">  pthread_mutex_lock(&amp;foo);</div><div class="line">  ...</div><div class="line">  pthread_mutex_unlock(&amp;foo);</div><div class="line">}</div></div><!-- fragment --><p>MySQL already provides some wrappers, to make the code platform independent, as in</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="thr__mutex_8h.html">thr_mutex.h</a>&quot;</span></div><div class="line"></div><div class="line"><a class="code" href="structmy__mutex__t.html">my_mutex_t</a> foo;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> do_something()</div><div class="line">{</div><div class="line">  <a class="code" href="thr__mutex_8h.html#a9481a364e229a50224580d8b64946492">my_mutex_lock</a>(&amp;foo);</div><div class="line">  ...</div><div class="line">  <a class="code" href="thr__mutex_8h.html#ace2a35f19ab828349f52e05bf510f5ef">my_mutex_unlock</a>(&amp;foo);</div><div class="line">}</div></div><!-- fragment --><p>Code using <code>my_mutex_t</code> is not instrumented for performance measurement.</p>
<h1><a class="anchor" id="PFS_PSI_SERVER"></a>
Instrumentation for server code</h1>
<p>To instrument the code, use a <code>mysql_mutex_t</code> instead. All the APIs provided are meant to be used as a simple replacement.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="psi_2mysql__mutex_8h.html">mysql/psi/mysql_mutex.h</a>&quot;</span></div><div class="line"></div><div class="line"><a class="code" href="structmysql__mutex__t.html">mysql_mutex_t</a> foo;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> do_something()</div><div class="line">{</div><div class="line">  <a class="code" href="components_2services_2mysql__mutex_8h.html#a340bf8f49d0cbaa994eaf5fb1fc7a22f">mysql_mutex_lock</a>(&amp;foo);</div><div class="line">  ...</div><div class="line">  <a class="code" href="components_2services_2mysql__mutex_8h.html#a5c748d3c7862702885acb90576754a2c">mysql_mutex_unlock</a>(&amp;foo);</div><div class="line">}</div></div><!-- fragment --><p>The server code can be built with or without each kind of instrumentation.</p>
<p>If cmake is configured with <code>-DDISABLE_PSI_MUTEX</code>, the mutex instrumentation is not compiled. In this case, <code>HAVE_PSI_MUTEX_INTERFACE</code> is not defined, so that <code>mysql_mutex_lock()</code> expands into</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div><div class="line"><a class="code" href="group__psi__api__mutex.html#ga67b4d5e45fc3337982ee21a6561656dd">inline_mysql_mutex_lock</a>(<a class="code" href="structmysql__mutex__t.html">mysql_mutex_t</a> *that,</div><div class="line">                        <span class="keyword">const</span> <span class="keywordtype">char</span> *src_file MY_ATTRIBUTE((unused)),</div><div class="line">                        <a class="code" href="uca-dump_8cc.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> src_line MY_ATTRIBUTE((unused))</div><div class="line">                        )</div><div class="line">{</div><div class="line">  <span class="keywordtype">int</span> <a class="code" href="plugin_2group__replication_2libmysqlgcs_2src_2bindings_2xcom_2xcom_2result_8h.html#a7ea7acca524ae6be65936dee80774179">result</a>;</div><div class="line"></div><div class="line">  ... Non instrumented code ...</div><div class="line">  result = <a class="code" href="thr__mutex_8h.html#a9481a364e229a50224580d8b64946492">my_mutex_lock</a>(&amp;that-&gt;<a class="code" href="structmysql__mutex__t.html#adf9c9c615ec147399975e8d168852dbd">m_mutex</a>);</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> <a class="code" href="plugin_2group__replication_2libmysqlgcs_2src_2bindings_2xcom_2xcom_2result_8h.html#a7ea7acca524ae6be65936dee80774179">result</a>;</div><div class="line">}</div></div><!-- fragment --><p>In other words, when not building with instrumentation, <code>mysql_mutex_lock()</code> is simply replaced with the actual call to <code>my_mutex_lock()</code>,</p>
<p>When building with the mutex instrumentation enabled (the default), <code>mysql_mutex_lock()</code> expands into this sequence.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div><div class="line"><a class="code" href="group__psi__api__mutex.html#ga67b4d5e45fc3337982ee21a6561656dd">inline_mysql_mutex_lock</a>(<a class="code" href="structmysql__mutex__t.html">mysql_mutex_t</a> *that,</div><div class="line">                        <span class="keyword">const</span> <span class="keywordtype">char</span> *src_file,</div><div class="line">                        <a class="code" href="uca-dump_8cc.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> src_line)</div><div class="line">{</div><div class="line">  <span class="keywordtype">int</span> <a class="code" href="plugin_2group__replication_2libmysqlgcs_2src_2bindings_2xcom_2xcom_2result_8h.html#a7ea7acca524ae6be65936dee80774179">result</a>;</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef HAVE_PSI_MUTEX_INTERFACE</span></div><div class="line">  <span class="keywordflow">if</span> (that-&gt;<a class="code" href="structmysql__mutex__t.html#a44c702250bf7a4344d3460c099e8ed07">m_psi</a> != <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div><div class="line">  {</div><div class="line">    ... (a) Instrumentation <a class="code" href="http__auth__backend__plugin_8cc.html#aee70c8416f705726100824ba89f1e090">start</a> ...</div><div class="line">    <a class="code" href="group__psi__abi__mutex.html#ga98b8cc3f9d2fbaa8b7e8e7bacb6ef7ce">PSI_mutex_locker</a> *locker;</div><div class="line">    <a class="code" href="structPSI__mutex__locker__state__v1.html">PSI_mutex_locker_state</a> state;</div><div class="line">    locker = <a class="code" href="components_2services_2psi__mutex_8h.html#a058a97056c5fb12117863219abd7a9ff">PSI_MUTEX_CALL</a>(start_mutex_wait)(</div><div class="line">      &amp;state, that-&gt;<a class="code" href="structmysql__mutex__t.html#a44c702250bf7a4344d3460c099e8ed07">m_psi</a>, <a class="code" href="group__psi__abi__mutex.html#gga1c8f497ceb563e76608b76d5cca651b2ad5000403a994eceb6d6fa5bad1d74f0d">PSI_MUTEX_LOCK</a>, src_file, src_line);</div><div class="line"></div><div class="line">    ... (b) Instrumented code ...</div><div class="line">    result = <a class="code" href="thr__mutex_8h.html#a9481a364e229a50224580d8b64946492">my_mutex_lock</a>(&amp;that-&gt;<a class="code" href="structmysql__mutex__t.html#adf9c9c615ec147399975e8d168852dbd">m_mutex</a>);</div><div class="line"></div><div class="line">    ... (c) Instrumentation <a class="code" href="namespacerules__table__service.html#a71d6ca457fe4ae5d5151f92c06cc3fd3">end</a> ...</div><div class="line">    <span class="keywordflow">if</span> (locker != <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div><div class="line">    {</div><div class="line">      <a class="code" href="components_2services_2psi__mutex_8h.html#a058a97056c5fb12117863219abd7a9ff">PSI_MUTEX_CALL</a>(end_mutex_wait)(locker, <a class="code" href="plugin_2group__replication_2libmysqlgcs_2src_2bindings_2xcom_2xcom_2result_8h.html#a7ea7acca524ae6be65936dee80774179">result</a>);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="plugin_2group__replication_2libmysqlgcs_2src_2bindings_2xcom_2xcom_2result_8h.html#a7ea7acca524ae6be65936dee80774179">result</a>;</div><div class="line">  }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">  ... Non instrumented code ...</div><div class="line">  result = <a class="code" href="thr__mutex_8h.html#a9481a364e229a50224580d8b64946492">my_mutex_lock</a>(&amp;that-&gt;<a class="code" href="structmysql__mutex__t.html#adf9c9c615ec147399975e8d168852dbd">m_mutex</a>);</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> <a class="code" href="plugin_2group__replication_2libmysqlgcs_2src_2bindings_2xcom_2xcom_2result_8h.html#a7ea7acca524ae6be65936dee80774179">result</a>;</div><div class="line">}</div></div><!-- fragment --><p>For a given instrumentation point in the API, the basic coding pattern used is:</p><ul>
<li>(a) notify the performance schema of the operation about to be performed.</li>
<li>(b) execute the instrumented code.</li>
<li>(c) notify the performance schema that the operation is completed.</li>
</ul>
<p>An opaque "locker" pointer is returned by (a), that is given to (c). This pointer helps the implementation to keep context, for performances.</p>
<p>The following code fragment is annotated to show how in detail this pattern in implemented, when the instrumentation is compiled in statically. In this case, the <code>PSI_MUTEX_CALL</code> macro expands to a function call, which results in</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div><div class="line"><a class="code" href="group__psi__api__mutex.html#ga67b4d5e45fc3337982ee21a6561656dd">inline_mysql_mutex_lock</a>(<a class="code" href="structmysql__mutex__t.html">mysql_mutex_t</a> *that,</div><div class="line">                        <span class="keyword">const</span> <span class="keywordtype">char</span> *src_file,</div><div class="line">                        <a class="code" href="uca-dump_8cc.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> src_line)</div><div class="line">{</div><div class="line">  <span class="keywordtype">int</span> <a class="code" href="plugin_2group__replication_2libmysqlgcs_2src_2bindings_2xcom_2xcom_2result_8h.html#a7ea7acca524ae6be65936dee80774179">result</a>;</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef HAVE_PSI_MUTEX_INTERFACE</span></div><div class="line">  <span class="keywordflow">if</span> (that-&gt;<a class="code" href="structmysql__mutex__t.html#a44c702250bf7a4344d3460c099e8ed07">m_psi</a> != <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div><div class="line">  {</div><div class="line">    ... (a) Instrumentation <a class="code" href="http__auth__backend__plugin_8cc.html#aee70c8416f705726100824ba89f1e090">start</a> ...</div><div class="line">    <a class="code" href="group__psi__abi__mutex.html#ga98b8cc3f9d2fbaa8b7e8e7bacb6ef7ce">PSI_mutex_locker</a> *locker;</div><div class="line">    <a class="code" href="structPSI__mutex__locker__state__v1.html">PSI_mutex_locker_state</a> state;</div><div class="line">    locker = <a class="code" href="pfs__mutex__provider_8h.html#a8a9b6c9ecf2a7ec98742db9494fac5b6">pfs_start_mutex_wait_v1</a>(</div><div class="line">      &amp;state, that-&gt;<a class="code" href="structmysql__mutex__t.html#a44c702250bf7a4344d3460c099e8ed07">m_psi</a>, <a class="code" href="group__psi__abi__mutex.html#gga1c8f497ceb563e76608b76d5cca651b2ad5000403a994eceb6d6fa5bad1d74f0d">PSI_MUTEX_LOCK</a>, src_file, src_line);</div><div class="line"></div><div class="line">    ... (b) Instrumented code ...</div><div class="line">    result = <a class="code" href="thr__mutex_8h.html#a9481a364e229a50224580d8b64946492">my_mutex_lock</a>(&amp;that-&gt;<a class="code" href="structmysql__mutex__t.html#adf9c9c615ec147399975e8d168852dbd">m_mutex</a>);</div><div class="line"></div><div class="line">    ... (c) Instrumentation <a class="code" href="namespacerules__table__service.html#a71d6ca457fe4ae5d5151f92c06cc3fd3">end</a> ...</div><div class="line">    <span class="keywordflow">if</span> (locker != <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div><div class="line">    {</div><div class="line">      <a class="code" href="pfs__mutex__provider_8h.html#a32737d2be0ebcae6b890c91f6c0549fa">pfs_end_mutex_wait_v1</a>(locker, result);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="plugin_2group__replication_2libmysqlgcs_2src_2bindings_2xcom_2xcom_2result_8h.html#a7ea7acca524ae6be65936dee80774179">result</a>;</div><div class="line">  }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">  ... Non instrumented code ...</div><div class="line">  result = <a class="code" href="thr__mutex_8h.html#a9481a364e229a50224580d8b64946492">my_mutex_lock</a>(&amp;that-&gt;<a class="code" href="structmysql__mutex__t.html#adf9c9c615ec147399975e8d168852dbd">m_mutex</a>);</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> <a class="code" href="plugin_2group__replication_2libmysqlgcs_2src_2bindings_2xcom_2xcom_2result_8h.html#a7ea7acca524ae6be65936dee80774179">result</a>;</div><div class="line">}</div></div><!-- fragment --><p>When the performance schema is disabled at runtime, the <code>m_psi</code> pointer is <code>NULL</code>, so the extra overhead is one if statement.</p>
<p>When the performance schema is enabled at runtime, the <code>m_psi</code> pointer points to the actual instrumentation added to the mutex, and two extra calls are present on the code path:</p><ul>
<li>a call to <code>pfs_start_mutex_wait_v1()</code> before the operation</li>
<li>a call to <code>pfs_end_mutex_wait_v1()</code> after the operation</li>
</ul>
<p>Both these calls are static, and point directly to the performance_schema implementation.</p>
<h1><a class="anchor" id="PFS_PSI_PLUGIN"></a>
Instrumentation for a plugin</h1>
<p>Inside a plugin, <code>PSI_MUTEX_CALL</code> expands to a call using a function pointer. This is to decouple the plugin binary from the implementation, to avoid having hard coded references to symbols like pfs_start_mutex_wait_v1() from the plugin library (either shared or static).</p>
<p>The plugin library, however, still depends on a symbol to be provided by the server, in this case <code>psi_mutex_service</code>.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div><div class="line"><a class="code" href="group__psi__api__mutex.html#ga67b4d5e45fc3337982ee21a6561656dd">inline_mysql_mutex_lock</a>(<a class="code" href="structmysql__mutex__t.html">mysql_mutex_t</a> *that,</div><div class="line">                        <span class="keyword">const</span> <span class="keywordtype">char</span> *src_file,</div><div class="line">                        <a class="code" href="uca-dump_8cc.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> src_line)</div><div class="line">{</div><div class="line">  <span class="keywordtype">int</span> <a class="code" href="plugin_2group__replication_2libmysqlgcs_2src_2bindings_2xcom_2xcom_2result_8h.html#a7ea7acca524ae6be65936dee80774179">result</a>;</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef HAVE_PSI_MUTEX_INTERFACE</span></div><div class="line">  <span class="keywordflow">if</span> (that-&gt;<a class="code" href="structmysql__mutex__t.html#a44c702250bf7a4344d3460c099e8ed07">m_psi</a> != <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div><div class="line">  {</div><div class="line">    ... (a) Instrumentation <a class="code" href="http__auth__backend__plugin_8cc.html#aee70c8416f705726100824ba89f1e090">start</a> ...</div><div class="line">    <a class="code" href="group__psi__abi__mutex.html#ga98b8cc3f9d2fbaa8b7e8e7bacb6ef7ce">PSI_mutex_locker</a> *locker;</div><div class="line">    <a class="code" href="structPSI__mutex__locker__state__v1.html">PSI_mutex_locker_state</a> state;</div><div class="line">    locker = <a class="code" href="group__psi__abi__mutex.html#ga90bbbdc21ab36c5bce9e3279076396cb">psi_mutex_service</a>-&gt;<a class="code" href="structPSI__mutex__service__v1.html#a4fcb4a4dbf6c9c4adbe58ef5370c7517">start_mutex_wait</a>(</div><div class="line">      &amp;state, that-&gt;<a class="code" href="structmysql__mutex__t.html#a44c702250bf7a4344d3460c099e8ed07">m_psi</a>, <a class="code" href="group__psi__abi__mutex.html#gga1c8f497ceb563e76608b76d5cca651b2ad5000403a994eceb6d6fa5bad1d74f0d">PSI_MUTEX_LOCK</a>, src_file, src_line);</div><div class="line"></div><div class="line">    ... (b) Instrumented code ...</div><div class="line">    result = <a class="code" href="thr__mutex_8h.html#a9481a364e229a50224580d8b64946492">my_mutex_lock</a>(&amp;that-&gt;<a class="code" href="structmysql__mutex__t.html#adf9c9c615ec147399975e8d168852dbd">m_mutex</a>);</div><div class="line"></div><div class="line">    ... (c) Instrumentation <a class="code" href="namespacerules__table__service.html#a71d6ca457fe4ae5d5151f92c06cc3fd3">end</a> ...</div><div class="line">    <span class="keywordflow">if</span> (locker != <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div><div class="line">    {</div><div class="line">      <a class="code" href="group__psi__abi__mutex.html#ga90bbbdc21ab36c5bce9e3279076396cb">psi_mutex_service</a>-&gt;<a class="code" href="structPSI__mutex__service__v1.html#a234ef339751155a17702300a2fa1801b">end_mutex_wait</a>(locker, result);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="plugin_2group__replication_2libmysqlgcs_2src_2bindings_2xcom_2xcom_2result_8h.html#a7ea7acca524ae6be65936dee80774179">result</a>;</div><div class="line">  }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">  ... Non instrumented code ...</div><div class="line">  result = <a class="code" href="thr__mutex_8h.html#a9481a364e229a50224580d8b64946492">my_mutex_lock</a>(&amp;that-&gt;<a class="code" href="structmysql__mutex__t.html#adf9c9c615ec147399975e8d168852dbd">m_mutex</a>);</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> <a class="code" href="plugin_2group__replication_2libmysqlgcs_2src_2bindings_2xcom_2xcom_2result_8h.html#a7ea7acca524ae6be65936dee80774179">result</a>;</div><div class="line">}</div></div><!-- fragment --><p>This solution works overall, but has some limitations.</p>
<h1><a class="anchor" id="PFS_PSI_COMPONENT"></a>
Instrumentation for component</h1>
<p>The goal when compiling a component is to have zero linker dependencies on the server code, and have technical dependencies described as references to services instead.</p>
<p>Another goal is to compile code the same way, independently of the technical choices affecting the implementation (pthread mutexes or native windows critical sections, SAFE_MUTEX debug helpers or not, etc)</p>
<p>For the mutex instrumentation in particular, the pattern used is to have a service that delegates all decisions to the server code. For this reason, all the parameters that might or might not be needed depending on the ultimate implementation (such as <code><b>FILE</b></code> and <code><b>LINE</b></code> for <code>SAFE_MUTEX</code>) are provided in all cases.</p>
<p>In a component, the code is instrumented using a different header file, everything else is the same.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;mysql/component/services/mysql_mutex.h&quot;</span></div><div class="line"></div><div class="line"><a class="code" href="structmysql__mutex__t.html">mysql_mutex_t</a> foo;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> do_something()</div><div class="line">{</div><div class="line">  <a class="code" href="components_2services_2mysql__mutex_8h.html#a340bf8f49d0cbaa994eaf5fb1fc7a22f">mysql_mutex_lock</a>(&amp;foo);</div><div class="line">  ...</div><div class="line">  <a class="code" href="components_2services_2mysql__mutex_8h.html#a5c748d3c7862702885acb90576754a2c">mysql_mutex_unlock</a>(&amp;foo);</div><div class="line">}</div></div><!-- fragment --><p>The call to <code>mysql_mutex_lock()</code> expands into</p>
<div class="fragment"><div class="line"><a class="code" href="component__implementation_8h.html#a46f8a5cd00a563671cf12d0b8341b856">REQUIRES_SERVICE_PLACEHOLDER</a>(mysql_mutex_v1);</div><div class="line"></div><div class="line">mysql_service_mysql_mutex_v1-&gt;lock(<a class="code" href="ctype-tis620_8cc.html#a52037c938e3c1b126c6277da5ca689d0">M</a>, __FILE__, __LINE__);</div></div><!-- fragment --><p>In the component metadata, the dependency on the mutex service needs to be declared explicitly, as in:</p>
<div class="fragment"><div class="line"><a class="code" href="component__implementation_8h.html#a415e8ffe4f2fbe44bc2df53b4db34144">BEGIN_COMPONENT_REQUIRES</a>(pfs_example)</div><div class="line">  <a class="code" href="component__implementation_8h.html#a4386b0b14a7598190801fbcdca45e8b8">REQUIRES_SERVICE</a>(mysql_mutex_v1)</div><div class="line"><a class="code" href="component__implementation_8h.html#a0a5670f2184a20e8776ce0bffad68574">END_COMPONENT_REQUIRES</a>();</div></div><!-- fragment --><p>When the component is loaded:</p><ul>
<li>the loader inspects the COMPONENT_REQUIRES metadata, and find the service dependencies</li>
<li>service dependencies are resolved, which assigns a proper value to the <code>mysql_service_mysql_mutex_v1</code> pointer.</li>
</ul>
<p>From this point, code compiled in the component can be executed normally, and calls to <code>mysql_mutex_lock()</code> land into the service implementation, which is a simple instrumented mutex lock compiled in the server.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span></div><div class="line"><a class="code" href="mysql__mutex__service_8cc.html#a918df3a25b1ba5eed7a6b88da0e81744">impl_mysql_mutex_lock</a>(</div><div class="line">  <a class="code" href="structmysql__mutex__t.html">mysql_mutex_t</a> *that,</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> *src_file,</div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> src_line)</div><div class="line">{</div><div class="line">  <span class="keywordflow">return</span> <a class="code" href="components_2services_2mysql__mutex_8h.html#a4b4b4fdc4fedc7368d8f5a4b955f174a">mysql_mutex_lock_with_src</a>(that, src_file, src_line);</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="PFS_PSI_LIST"></a>
List of available instrumentation</h1>
<p>The current list of instrumentation provided by the performance schema is as follows:</p>
<a class="anchor" id="list_pfs_instr"></a>
<table class="doxtable">
<caption>List of available instrumentation</caption>
<tr>
<th rowspan="2">Scope </th><th colspan="2">User code </th><th colspan="2">Implementation entry point  </th></tr>
<tr>
<th>Server or Plugin </th><th>Component </th><th>Server or Plugin </th><th><p class="starttd">Component </p>
<p class="endtd"></p>
</th></tr>
<tr>
<td>Mutex (high level) </td><td><pre class="fragment">#include "mysql/psi/mysql_mutex.h"
mysql_mutex_lock()
</pre>  </td><td><pre class="fragment">#include "mysql/components/services/mysql_mutex.h"
mysql_mutex_lock()
</pre>  </td><td><a class="el" href="structPSI__mutex__bootstrap.html">PSI_mutex_bootstrap</a> </td><td><p class="starttd"><a class="el" href="pfs__example_8cc.html#a137fdf334720286c5ebf660d55c22b27">REQUIRES_MYSQL_MUTEX_SERVICE</a> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Rwlock (high level) </td><td><pre class="fragment">#include "mysql/psi/mysql_rwlock.h"
mysql_rwlock_rdlock()
</pre>  </td><td><pre class="fragment">#include "mysql/components/services/mysql_rwlock.h"
mysql_rwlock_rdlock()
</pre>  </td><td><a class="el" href="structPSI__rwlock__bootstrap.html">PSI_rwlock_bootstrap</a> </td><td><p class="starttd"><a class="el" href="validate__password__imp_8cc.html#a8c6e588db2733844dd127aceb2049168">REQUIRES_MYSQL_RWLOCK_SERVICE</a> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Conditions (high level) </td><td><pre class="fragment">#include "mysql/psi/mysql_cond.h"
mysql_cond_wait()
</pre>  </td><td><pre class="fragment">#include "mysql/components/services/mysql_cond.h"
mysql_cond_wait()
</pre>  </td><td><a class="el" href="structPSI__cond__bootstrap.html">PSI_cond_bootstrap</a> </td><td><p class="starttd"><a class="el" href="pfs__example_8cc.html#a63bfaab589254315c3258eb2f053712c">REQUIRES_MYSQL_COND_SERVICE</a> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Mutex (low level) </td><td><pre class="fragment">#include "mysql/psi/psi_mutex.h"
PSI_MUTEX_CALL(start_mutex_wait)(...)
PSI_MUTEX_CALL(end_mutex_wait)(...)
</pre>  </td><td><pre class="fragment">#include "mysql/components/services/psi_mutex.h"
PSI_MUTEX_CALL(start_mutex_wait)(...)
PSI_MUTEX_CALL(end_mutex_wait)(...)
</pre>  </td><td><a class="el" href="structPSI__mutex__bootstrap.html">PSI_mutex_bootstrap</a> </td><td><p class="starttd"><a class="el" href="pfs__example_8cc.html#a4c5951a0cc0a1d6cb282a8683e2edf9e">REQUIRES_PSI_MUTEX_SERVICE</a> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Rwlock (low level) </td><td><pre class="fragment">#include "mysql/psi/psi_rwlock.h"
PSI_RWLOCK_CALL(start_rwlock_rdwait)(...)
PSI_RWLOCK_CALL(end_rwlock_rdwait)(...)
</pre>  </td><td><pre class="fragment">#include "mysql/components/services/psi_rwlock.h"
PSI_RWLOCK_CALL(start_rwlock_rdwait)(...)
PSI_RWLOCK_CALL(end_rwlock_rdwait)(...)
</pre>  </td><td><a class="el" href="structPSI__rwlock__bootstrap.html">PSI_rwlock_bootstrap</a> </td><td><p class="starttd"><a class="el" href="pfs__example_8cc.html#a34c4a4cb2f76f11c63164d8c0a0dfc1d">REQUIRES_PSI_RWLOCK_SERVICE</a> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Conditions (low level) </td><td><pre class="fragment">#include "mysql/psi/mysql_cond.h"
PSI_COND_CALL(start_cond_wait)(...)
PSI_COND_CALL(end_cond_wait)(...)
</pre>  </td><td><pre class="fragment">#include "mysql/components/services/psi_cond.h"
PSI_COND_CALL(start_cond_wait)(...)
PSI_COND_CALL(end_cond_wait)(...)
</pre>  </td><td><a class="el" href="structPSI__cond__bootstrap.html">PSI_cond_bootstrap</a> </td><td><p class="starttd"><a class="el" href="pfs__example_8cc.html#a79e900906cf3a8bfb17337f5e8d57fbc">REQUIRES_PSI_COND_SERVICE</a> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Errors </td><td><pre class="fragment">#include "mysql/psi/psi_error.h"
PSI_ERROR_CALL(log_error)(...)
</pre>  </td><td><pre class="fragment">#include "mysql/components/services/psi_error.h"
PSI_ERROR_CALL(log_error)(...)
</pre>  </td><td><a class="el" href="structPSI__error__bootstrap.html">PSI_error_bootstrap</a> </td><td><p class="starttd"><a class="el" href="pfs__example_8cc.html#a523abbac140e60200fbe35338ae7ab82">REQUIRES_PSI_ERROR_SERVICE</a> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>File </td><td><pre class="fragment">#include "mysql/psi/psi_file.h"
PSI_FILE_CALL(start_file_wait)(...)
PSI_FILE_CALL(end_file_wait)(...)
</pre>  </td><td><pre class="fragment">#include "mysql/components/services/psi_file.h"
PSI_FILE_CALL(start_file_wait)(...)
PSI_FILE_CALL(end_file_wait)(...)
</pre>  </td><td><a class="el" href="structPSI__file__bootstrap.html">PSI_file_bootstrap</a> </td><td><p class="starttd"><a class="el" href="pfs__example_8cc.html#abc672bf5b7ed169e3815c458ed03645b">REQUIRES_PSI_FILE_SERVICE</a> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Idle </td><td><pre class="fragment">#include "mysql/psi/psi_idle.h"
PSI_IDLE_CALL(start_idle_wait)(...)
PSI_IDLE_CALL(end_idle_wait)(...)
</pre>  </td><td><pre class="fragment">#include "mysql/components/services/psi_idle.h"
PSI_IDLE_CALL(start_idle_wait)(...)
PSI_IDLE_CALL(end_idle_wait)(...)
</pre>  </td><td><a class="el" href="structPSI__idle__bootstrap.html">PSI_idle_bootstrap</a> </td><td><p class="starttd"><a class="el" href="pfs__example_8cc.html#a9069c631ece0a47acb103ebd02490d40">REQUIRES_PSI_IDLE_SERVICE</a> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Metadata locks </td><td><pre class="fragment">#include "mysql/psi/psi_mdl.h"
PSI_METADATA_CALL(start_metadata_wait)(...)
PSI_METADATA_CALL(end_metadata_wait)(...)
</pre>  </td><td><pre class="fragment">#include "mysql/components/services/psi_mdl.h"
PSI_METADATA_CALL(start_metadata_wait)(...)
PSI_METADATA_CALL(end_metadata_wait)(...)
</pre>  </td><td><a class="el" href="structPSI__mdl__bootstrap.html">PSI_mdl_bootstrap</a> </td><td><p class="starttd"><a class="el" href="pfs__example_8cc.html#a73845e3b1b310bd4159a0df0aa0aaa97">REQUIRES_PSI_MDL_SERVICE</a> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Memory </td><td><pre class="fragment">#include "mysql/psi/psi_memory.h"
PSI_MEMORY_CALL(memory_alloc)(...)
PSI_MEMORY_CALL(memory_free)(...)
</pre>  </td><td><pre class="fragment">#include "mysql/components/services/psi_memory.h"
PSI_MEMORY_CALL(memory_alloc)(...)
PSI_MEMORY_CALL(memory_free)(...)
</pre>  </td><td><a class="el" href="structPSI__memory__bootstrap.html">PSI_memory_bootstrap</a> </td><td><p class="starttd"><a class="el" href="validate__password__imp_8cc.html#af144e4f00c82ec13562f720176d18efa">REQUIRES_PSI_MEMORY_SERVICE</a> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Socket </td><td><pre class="fragment">#include "mysql/psi/psi_socket.h"
PSI_SOCKET_CALL(start_socket_wait)(...)
PSI_SOCKET_CALL(end_socket_wait)(...)
</pre>  </td><td><pre class="fragment">#include "mysql/components/services/psi_socket.h"
PSI_SOCKET_CALL(start_socket_wait)(...)
PSI_SOCKET_CALL(end_socket_wait)(...)
</pre>  </td><td><a class="el" href="structPSI__socket__bootstrap.html">PSI_socket_bootstrap</a> </td><td><p class="starttd"><a class="el" href="pfs__example_8cc.html#addd4e9e400c09a1b49c3828f41d8b852">REQUIRES_PSI_SOCKET_SERVICE</a> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Stage </td><td><pre class="fragment">#include "mysql/psi/psi_stage.h"
PSI_STAGE_CALL(start_stage)(...)
</pre>  </td><td><pre class="fragment">#include "mysql/components/services/psi_stage.h"
PSI_STAGE_CALL(start_stage)(...)
</pre>  </td><td><a class="el" href="structPSI__stage__bootstrap.html">PSI_stage_bootstrap</a> </td><td><p class="starttd"><a class="el" href="pfs__example_8cc.html#a6f7190d8fda20d4739737c0c914e95c5">REQUIRES_PSI_STAGE_SERVICE</a> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Statement </td><td><pre class="fragment">#include "mysql/psi/psi_statement.h"
PSI_STATEMENT_CALL(start_statement)(...)
PSI_STATEMENT_CALL(end_statement)(...)

Extra helpers available:
MYSQL_START_STATEMENT()
MYSQL_END_STATEMENT()
</pre>  </td><td><pre class="fragment">#include "mysql/components/services/psi_statement.h"
PSI_STATEMENT_CALL(start_statement)(...)
PSI_STATEMENT_CALL(end_statement)(...)
</pre>  </td><td><a class="el" href="structPSI__statement__bootstrap.html">PSI_statement_bootstrap</a> </td><td><p class="starttd"><a class="el" href="pfs__example_8cc.html#ac3b100d2d931f44c2d51e40f06977c4a">REQUIRES_PSI_STATEMENT_SERVICE</a> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Table </td><td><pre class="fragment">#include "mysql/psi/psi_table.h"
PSI_TABLE_CALL(start_table_io_wait)(...)
PSI_TABLE_CALL(end_table_io_wait)(...)
</pre>  </td><td><pre class="fragment">#include "mysql/components/services/psi_table.h"
PSI_TABLE_CALL(start_table_io_wait)(...)
PSI_TABLE_CALL(end_table_io_wait)(...)
</pre>  </td><td><a class="el" href="structPSI__table__bootstrap.html">PSI_table_bootstrap</a> </td><td><p class="starttd"><a class="el" href="pfs__example_8cc.html#ae22da538f13a257c062a4f1153317e1b">REQUIRES_PSI_TABLE_SERVICE</a> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>System </td><td><pre class="fragment">#include "mysql/psi/psi_system.h"
PSI_SYSTEM_CALL(plugin_unload)(...)
</pre>  </td><td><pre class="fragment">#include "mysql/components/services/psi_system.h"
PSI_SYSTEM_CALL(plugin_unload)(...)
</pre>  </td><td><a class="el" href="structPSI__system__bootstrap.html">PSI_system_bootstrap</a> </td><td><p class="starttd"><a class="el" href="components_2services_2psi__system_8h.html#afce5c9d48120a85d2632e3a7fae4fd79">REQUIRES_PSI_SYSTEM_SERVICE</a> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Thread </td><td><pre class="fragment">#include "mysql/psi/psi_thread.h"
PSI_THREAD_CALL(spawn_thread)(...)
PSI_THREAD_CALL(delete_thread)(...)
</pre>  </td><td><pre class="fragment">#include "mysql/components/services/psi_thread.h"
PSI_THREAD_CALL(spawn_thread)(...)
PSI_THREAD_CALL(delete_thread)(...)
</pre>  </td><td><a class="el" href="structPSI__thread__bootstrap.html">PSI_thread_bootstrap</a> </td><td><p class="starttd"><a class="el" href="pfs__example_8cc.html#ab917352e2e576d473f9a2e07deb04aa7">REQUIRES_PSI_THREAD_SERVICE</a> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Transaction </td><td><pre class="fragment">#include "mysql/psi/psi_transaction.h"
PSI_TRANSACTION_CALL(start_transaction)(...)
PSI_TRANSACTION_CALL(end_transaction)(...)
</pre>  </td><td><pre class="fragment">#include "mysql/components/services/psi_transaction.h"
PSI_TRANSACTION_CALL(start_transaction)(...)
PSI_TRANSACTION_CALL(end_transaction)(...)
</pre>  </td><td><a class="el" href="structPSI__transaction__bootstrap.html">PSI_transaction_bootstrap</a> </td><td><p class="starttd"><a class="el" href="pfs__example_8cc.html#ada6f16ad7e76834ae2f3e372c199ffac">REQUIRES_PSI_TRANSACTION_SERVICE</a> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>Data locks </td><td><pre class="fragment">#include "mysql/psi/psi_data_lock.h"
PSI_DATA_LOCK_CALL(register_data_lock)(...)
PSI_DATA_LOCK_CALL(unregister_data_lock)(...)
</pre>  </td><td>Not available as a service. </td><td><a class="el" href="structPSI__data__lock__bootstrap.html">PSI_data_lock_bootstrap</a> </td><td><p class="starttd">Not available as a service. </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>TLS Channels </td><td><pre class="fragment">#include "mysql/psi/psi_tls_channel.h"
PSI_TLS_CHANNEL_CALL(register_tls_channel)(...)
PSI_TLS_CHANNEL_CALL(unregister_tls_channel)(...)
</pre>  </td><td><pre class="fragment">#include "mysql/components/services/psi_tls_channel.h"
PSI_TLS_CHANNEL_CALL(register_tls_channel)(...)
PSI_TLS_CHANNEL_CALL(unregister_tls_channel)(...)
</pre>  </td><td><a class="el" href="structPSI__tls__channel__bootstrap.html">PSI_tls_channel_bootstrap</a> </td><td><p class="starttd"><a class="el" href="pfs__example_8cc.html#ad0c76f17cb9c27ab9fda54237fcbb961">REQUIRES_PSI_TLS_CHANNEL_SERVICE</a> </p>
<p class="endtd"></p>
</td></tr>
</table>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="PAGE_MONITORING.html">Monitoring</a></li><li class="navelem"><a class="el" href="PAGE_PFS.html">Performance Schema</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
