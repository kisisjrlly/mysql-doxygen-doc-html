<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MySQL: Compressed Packet</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="mysql.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo-mysql-110x55.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MySQL
   &#160;<span id="projectnumber">8.0.22</span>
   </div>
   <div id="projectbrief">Source Code Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('page_protocol_basic_compression_packet.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Compressed Packet </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The compressed packet consists of a <a class="el" href="page_protocol_basic_compression_packet.html#sect_protocol_basic_compression_packet_header">Compressed Packet Header</a> and a payload which is either a <a class="el" href="page_protocol_basic_compression_packet.html#sect_protocol_basic_compression_packet_compressed_payload">Compressed Payload</a> or <a class="el" href="page_protocol_basic_compression_packet.html#sect_protocol_basic_compression_packet_uncompressed_payload">Uncompressed Payload</a>.</p>
<dl class="section see"><dt>See also</dt><dd>compress_packet, CLIENT_COMPRESS</dd></dl>
<h1><a class="anchor" id="sect_protocol_basic_compression_packet_header"></a>
Compressed Packet Header</h1>
<table class="doxtable">
<tr>
<th>Type</th><th>Name</th><th>Description </th></tr>
<tr>
<td><a class="el" href="page_protocol_basic_dt_integers.html#a_protocol_type_int3">int&lt;3&gt;</a> </td><td>length of compressed payload </td><td>raw packet length minus the size of the compressed packet header (7 bytes) itself. </td></tr>
<tr>
<td><a class="el" href="page_protocol_basic_dt_integers.html#a_protocol_type_int1">int&lt;1&gt;</a> </td><td>compressed sequence id </td><td>Sequence ID of the compressed packets, reset in the same way as the <a class="el" href="page_protocol_basic_packets.html#sect_protocol_basic_packets_packet">Protocol::Packet</a>, but incremented independently </td></tr>
</table>
<h1><a class="anchor" id="sect_protocol_basic_compression_packet_compressed_payload"></a>
Compressed Payload</h1>
<p>If the length of <em>length of payload before compression</em> is more than 0 the <a class="el" href="page_protocol_basic_compression_packet.html#sect_protocol_basic_compression_packet_header">Compressed Packet Header</a> is followed by the compressed payload.</p>
<p>It uses the <em>deflate</em> algorithm as described in <a href="http://tools.ietf.org/html/rfc1951.html">RFC 1951</a> and implemented in <a href="http://zlib.org/">zlib</a>. The header of the compressed packet has the parameters of the <code>uncompress()</code> function in mind:</p>
<div class="fragment"><div class="line">ZEXTERN <span class="keywordtype">int</span> ZEXPORT uncompress OF((Bytef *dest,   uLongf *destLen,</div><div class="line">                               <span class="keyword">const</span> Bytef *source, uLong sourceLen));</div></div><!-- fragment --><p>The payload can be anything from a piece of a MySQL Packet to several MySQL Packets. The client or server may bundle several MySQL packets, compress it and send it as one compressed packet.</p>
<h2><a class="anchor" id="sect_protocol_basic_compression_packet_compressed_payload_single"></a>
Example: One MySQL Packet</h2>
<p>A COM_QUERY for <code>select "012345678901234567890123456789012345"</code> without CLIENT_COMPRESS has a <em>payload length</em> of 46 bytes and looks like:</p>
<div class="fragment"><div class="line">2e 00 00 00 03 73 65 6c    65 63 74 20 22 30 31 32    .....select <span class="stringliteral">&quot;012</span></div><div class="line"><span class="stringliteral">33 34 35 36 37 38 39 30    31 32 33 34 35 36 37 38    3456789012345678</span></div><div class="line"><span class="stringliteral">39 30 31 32 33 34 35 36    37 38 39 30 31 32 33 34    9012345678901234</span></div><div class="line"><span class="stringliteral">35 22                                                 5&quot;</span></div></div><!-- fragment --><p>With CLIENT_COMPRESS the packet is:</p>
<div class="fragment"><div class="line">22 00 00 00 32 00 00 78    9c d3 63 60 60 60 2e 4e    <span class="stringliteral">&quot;...2..x..c```.N</span></div><div class="line"><span class="stringliteral">cd 49 4d 2e 51 50 32 30    34 32 36 31 35 33 b7 b0    .IM.QP20426153..</span></div><div class="line"><span class="stringliteral">c4 cd 52 02 00 0c d1 0a    6c                         ..R.....l</span></div></div><!-- fragment --><table class="doxtable">
<tr>
<th>comp-length</th><th>seq-id</th><th>uncomp-len</th><th>Compressed Payload </th></tr>
<tr>
<td><code>22 00 00</code></td><td><code>00</code></td><td><code>32 00 00</code></td><td>compress("\x2e\x00\x00\x00\x03select ...")` </td></tr>
</table>
<p>The compressed packet is 41 bytes long and splits into:</p>
<div class="fragment"><div class="line">raw packet <a class="code" href="namespacegis.html#a1e3bf735dbe640151561b282f0f4dba5">length</a>                      -&gt; 41</div><div class="line">compressed payload <a class="code" href="namespacegis.html#a1e3bf735dbe640151561b282f0f4dba5">length</a>   = 22 00 00 -&gt; 34 (41 - 7)</div><div class="line"><a class="code" href="udf__example_8cc.html#aa48a6c218d5a51dadae7378c4e83c109">sequence</a> <span class="keywordtype">id</span>                 = 00       -&gt;  0</div><div class="line">uncompressed payload length = 32 00 00 -&gt; 50</div></div><!-- fragment --><h2><a class="anchor" id="sect_protocol_basic_compression_packet_compressed_payload_multi"></a>
Example: Several MySQL Packets</h2>
<p>Executing <code>SELECT repeat("a", 50)</code> results in uncompressed ProtocolText::Resultset like: </p><div class="fragment"><div class="line">01 00 00 01 01 25 00 00    02 03 64 65 66 00 00 00    .....%....def...</div><div class="line">0f 72 65 70 65 61 74 28    22 61 22 2c 20 35 30 29    .repeat(<span class="stringliteral">&quot;a&quot;</span>, 50)</div><div class="line">00 0c 08 00 32 00 00 00    fd 01 00 1f 00 00 05 00    ....2...........</div><div class="line">00 03 fe 00 00 02 00 33    00 00 04 32 61 61 61 61    .......3...2aaaa</div><div class="line">61 61 61 61 61 61 61 61    61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa</div><div class="line">61 61 61 61 61 61 61 61    61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa</div><div class="line">61 61 61 61 61 61 61 61    61 61 61 61 61 61 05 00    aaaaaaaaaaaaaa..</div><div class="line">00 05 fe 00 00 02 00                                  .......</div></div><!-- fragment --><p>which consists of 5 <a class="el" href="page_protocol_basic_packets.html#sect_protocol_basic_packets_packet">Protocol::Packet</a> :</p>
<ul>
<li><code>01 00 00 01 01</code></li>
<li><code>25 00 00 02 03 64 65 66 00 00 00 0f 72 65 70 65 61 74 28 22 61 22 2c 20 35 30 29 00 0c 08 00 32 00 00 00 fd 01 00 1f 00 00</code></li>
<li><code>05 00 00 03 fe 00 00 02 00</code></li>
<li><code>33 00 00 04 32 61 61 61 61 ...</code></li>
<li><code>05 00 00 05 fe 00 00 02 00</code></li>
</ul>
<p>If compression is enabled a compressed packet containing the compressed version of all 5 packets is sent to the client:</p>
<div class="fragment"><div class="line">4a 00 00 01 77 00 00 78    9c 63 64 60 60 64 54 65    J...w..x.cd``dTe</div><div class="line">60 60 62 4e 49 4d 63 60    60 e0 2f 4a 2d 48 4d 2c    ``bNIMc``./J-HM,</div><div class="line"><a class="code" href="dtoa_8cc.html#a1fe17aa2ff1722c937379044a27da68a">d1</a> 50 4a 54 d2 51 30 35    <a class="code" href="dtoa_8cc.html#ade11f3df9cc63f54fa743250c646e270">d0</a> 64 e0 e1 60 30 02 8a    .PJT.Q05.d..`0..</div><div class="line">ff 65 64 90 67 60 60 65    60 60 fe 07 54 cc 60 cc    .ed.g``e``..T.`.</div><div class="line">c0 c0 62 94 48 32 00 ea    67 05 eb 07 00 8d f9 1c    ..b.H2..g.......</div><div class="line">64                                                    d</div></div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>sending a MySQL Packet of the size 2<sup>24</sup>-5 to 2<sup>24</sup>-1 via compression leads to at least one extra compressed packet. If the uncompressed MySQL Packet is like <div class="fragment"><div class="line">fe ff ff 03 ... -- length = 2^24-2, <a class="code" href="udf__example_8cc.html#aa48a6c218d5a51dadae7378c4e83c109">sequence</a> <span class="keywordtype">id</span> = 3</div></div><!-- fragment --> compressing it would result in the <em>length of payload before compression</em> in the <a class="el" href="page_protocol_basic_compression_packet.html#sect_protocol_basic_compression_packet_header">Compressed Packet Header</a> being: <div class="fragment"><div class="line">length of <a class="code" href="mysql_8cc.html#a79ca285a0c0e720422fa6fb6a4bba330">mysql</a> packet payload:       2^24-2</div><div class="line">length of <a class="code" href="mysql_8cc.html#a79ca285a0c0e720422fa6fb6a4bba330">mysql</a> packet header:        4</div><div class="line">length of payload before compression: 2^24+2</div></div><!-- fragment --> which can not be represented in one compressed packet. Instead two or more packets have to be sent.</dd></dl>
<h1><a class="anchor" id="sect_protocol_basic_compression_packet_uncompressed_payload"></a>
Uncompressed Payload</h1>
<p>For small packets it may be to costly to compress the packet:</p><ul>
<li>compressing the packet may lead to more data and sending the data uncompressed</li>
<li>CPU overhead may be not worth to compress the data <dl class="section user"><dt>Tip</dt><dd>Usually payloads less than 50 bytes (MIN_COMPRESS_LENGTH) aren't compressed.</dd></dl>
To send an <a class="el" href="page_protocol_basic_compression_packet.html#sect_protocol_basic_compression_packet_uncompressed_payload">Uncompressed Payload</a> :</li>
<li>set <em>length of payload before compression</em> in <a class="el" href="page_protocol_basic_compression_packet.html#sect_protocol_basic_compression_packet_header">Compressed Packet Header</a> to 0</li>
<li>The <a class="el" href="page_protocol_basic_compression_packet.html#sect_protocol_basic_compression_packet_compressed_payload">Compressed Payload</a> contains the <a class="el" href="page_protocol_basic_compression_packet.html#sect_protocol_basic_compression_packet_uncompressed_payload">Uncompressed Payload</a> instead.</li>
</ul>
<p>Sending a <code>SELECT 1</code> query as <a class="el" href="page_protocol_basic_compression_packet.html#sect_protocol_basic_compression_packet_uncompressed_payload">Uncompressed Payload</a> to the server looks like: </p><div class="fragment"><div class="line">0d 00 00 00 00 00 00 09    00 00 00 03 53 45 4c 45    ............SELE</div><div class="line">43 54 20 31                                           CT 1</div></div><!-- fragment --><p>decodes into: </p><div class="fragment"><div class="line">raw packet length                      -&gt; 20</div><div class="line">compressed payload length   = 0d 00 00 -&gt; 13 (20 - 7)</div><div class="line"><a class="code" href="udf__example_8cc.html#aa48a6c218d5a51dadae7378c4e83c109">sequence</a> <span class="keywordtype">id</span>                 = 00       -&gt;  0</div><div class="line">uncompressed payload length = 00 00 00 -&gt; uncompressed</div></div><!-- fragment --><p>... with the <em>uncompressed payload</em> starting right after the 7 byte header:</p>
<div class="fragment"><div class="line">09 00 00 00 03 53 45 4c 45 43 54 20 31 -- SELECT 1</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="PAGE_PROTOCOL.html">Client/Server Protocol</a></li><li class="navelem"><a class="el" href="page_protocol_basics.html">Protocol Basics</a></li><li class="navelem"><a class="el" href="page_protocol_basic_compression.html">Compression</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
