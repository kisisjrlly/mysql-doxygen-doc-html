<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MySQL: sql/hash_join_buffer.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="mysql.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo-mysql-110x55.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MySQL
   &#160;<span id="projectnumber">8.0.22</span>
   </div>
   <div id="projectbrief">Source Code Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('hash__join__buffer_8h.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#namespaces">Namespaces</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#enum-members">Enumerations</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">hash_join_buffer.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>This file contains the HashJoinRowBuffer class and related functions/classes.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;stddef.h&gt;</code><br />
<code>#include &lt;stdint.h&gt;</code><br />
<code>#include &lt;memory&gt;</code><br />
<code>#include &lt;vector&gt;</code><br />
<code>#include &quot;extra/lz4/my_xxhash.h&quot;</code><br />
<code>#include &quot;<a class="el" href="field__types_8h_source.html">field_types.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="map__helpers_8h_source.html">map_helpers.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="my__alloc_8h_source.html">my_alloc.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="my__inttypes_8h_source.html">my_inttypes.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="my__table__map_8h_source.html">my_table_map.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="prealloced__array_8h_source.html">prealloced_array.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="item__cmpfunc_8h_source.html">sql/item_cmpfunc.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="sql_2table_8h_source.html">sql/table.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="sql__string_8h_source.html">sql_string.h</a>&quot;</code><br />
</div>
<p><a href="hash__join__buffer_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structhash__join__buffer_1_1Column.html">hash_join_buffer::Column</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">A class that represents a field, which also holds a cached value of the field's data type.  <a href="structhash__join__buffer_1_1Column.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structhash__join__buffer_1_1Table.html">hash_join_buffer::Table</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">This struct is primarily used for holding the extracted columns in a hash join.  <a href="structhash__join__buffer_1_1Table.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classhash__join__buffer_1_1TableCollection.html">hash_join_buffer::TableCollection</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">A structure that contains a list of tables for the hash join operation, and some pre-computed properties for the tables.  <a href="classhash__join__buffer_1_1TableCollection.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classhash__join__buffer_1_1Key.html">hash_join_buffer::Key</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">The key type for the hash structure in HashJoinRowBuffer.  <a href="classhash__join__buffer_1_1Key.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classhash__join__buffer_1_1KeyHasher.html">hash_join_buffer::KeyHasher</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">We rely on xxHash64 to do the hashing of the key.  <a href="classhash__join__buffer_1_1KeyHasher.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classhash__join__buffer_1_1HashJoinRowBuffer.html">hash_join_buffer::HashJoinRowBuffer</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="namespaces"></a>
Namespaces</h2></td></tr>
<tr class="memitem:namespacehash__join__buffer"><td class="memItemLeft" align="right" valign="top"> &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacehash__join__buffer.html">hash_join_buffer</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr class="memitem:a3b286b8b28700500939ff9bf68bbb912"><td class="memItemLeft" align="right" valign="top">using&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacehash__join__buffer.html#a3b286b8b28700500939ff9bf68bbb912">hash_join_buffer::BufferRow</a> = Key</td></tr>
<tr class="separator:a3b286b8b28700500939ff9bf68bbb912"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="enum-members"></a>
Enumerations</h2></td></tr>
<tr class="memitem:a8848ca6306216bf066d1153c458684e5"><td class="memItemLeft" align="right" valign="top">enum &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacehash__join__buffer.html#a8848ca6306216bf066d1153c458684e5">hash_join_buffer::StoreRowResult</a> { <a class="el" href="namespacehash__join__buffer.html#a8848ca6306216bf066d1153c458684e5a6618e6deff9dacb17f2f582f3ec41076">hash_join_buffer::StoreRowResult::ROW_STORED</a>, 
<a class="el" href="namespacehash__join__buffer.html#a8848ca6306216bf066d1153c458684e5af46524fa13d0e02e2743d1db7279375d">hash_join_buffer::StoreRowResult::BUFFER_FULL</a>, 
<a class="el" href="namespacehash__join__buffer.html#a8848ca6306216bf066d1153c458684e5ac6179cb17067a08588ff65efb6d02cdd">hash_join_buffer::StoreRowResult::FATAL_ERROR</a>
 }</td></tr>
<tr class="separator:a8848ca6306216bf066d1153c458684e5"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a725bafb95fe8970676091bf04d0ff6ba"><td class="memItemLeft" align="right" valign="top">size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacehash__join__buffer.html#a725bafb95fe8970676091bf04d0ff6ba">hash_join_buffer::ComputeRowSizeUpperBound</a> (const TableCollection &amp;tables)</td></tr>
<tr class="memdesc:a725bafb95fe8970676091bf04d0ff6ba"><td class="mdescLeft">&#160;</td><td class="mdescRight">Count up how many bytes a single row from the given tables will occupy, in "packed" format.  <a href="namespacehash__join__buffer.html#a725bafb95fe8970676091bf04d0ff6ba">More...</a><br /></td></tr>
<tr class="separator:a725bafb95fe8970676091bf04d0ff6ba"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6b8900c6f3ab6a0c49ed50ba50e5c21b"><td class="memItemLeft" align="right" valign="top"><a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacehash__join__buffer.html#a6b8900c6f3ab6a0c49ed50ba50e5c21b">hash_join_buffer::StoreFromTableBuffers</a> (const TableCollection &amp;tables, <a class="el" href="classString.html">String</a> *<a class="el" href="test__sql__9__sessions_8cc.html#ac242a6dca06b33213957c913bd72414c">buffer</a>)</td></tr>
<tr class="memdesc:a6b8900c6f3ab6a0c49ed50ba50e5c21b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Take the data marked for reading in "tables" and store it in the provided buffer.  <a href="namespacehash__join__buffer.html#a6b8900c6f3ab6a0c49ed50ba50e5c21b">More...</a><br /></td></tr>
<tr class="separator:a6b8900c6f3ab6a0c49ed50ba50e5c21b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abad60ba4991a035fb26d286f26e56193"><td class="memItemLeft" align="right" valign="top">const <a class="el" href="my__inttypes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacehash__join__buffer.html#abad60ba4991a035fb26d286f26e56193">hash_join_buffer::LoadIntoTableBuffers</a> (const TableCollection &amp;tables, const <a class="el" href="my__inttypes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *ptr)</td></tr>
<tr class="memdesc:abad60ba4991a035fb26d286f26e56193"><td class="mdescLeft">&#160;</td><td class="mdescRight">Take the data in "ptr" and put it back to the tables' record buffers.  <a href="namespacehash__join__buffer.html#abad60ba4991a035fb26d286f26e56193">More...</a><br /></td></tr>
<tr class="separator:abad60ba4991a035fb26d286f26e56193"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5be8e7dfb0c278e5e005ed79780d41e8"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacehash__join__buffer.html#a5be8e7dfb0c278e5e005ed79780d41e8">hash_join_buffer::LoadIntoTableBuffers</a> (const TableCollection &amp;tables, BufferRow row)</td></tr>
<tr class="separator:a5be8e7dfb0c278e5e005ed79780d41e8"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>This file contains the HashJoinRowBuffer class and related functions/classes. </p>
<p>A HashJoinBuffer is a row buffer that can hold a certain amount of rows. The rows are stored in a hash table, which allows for constant-time lookup. The HashJoinBuffer maintains its own internal MEM_ROOT, where all of the data is allocated.</p>
<p>The HashJoinBuffer contains an operand with rows from one or more tables, keyed on the value we join on. Consider the following trivial example:</p>
<p>SELECT t1.data FROM t1 JOIN t2 ON (t1.key = t2.key);</p>
<p>Let us say that the table "t2" is stored in a HashJoinBuffer. In this case, the hash table key will be the value found in "t2.key", since that is the join condition that belongs to t2. If we have multiple equalities, they will be concatenated together in order to form the hash table key. The hash table key is bascially an std::string_view, and should be replaced when we go to C++17.</p>
<p>In order to store a row, we use the function StoreFromTableBuffers. See the comments attached to the function for more details.</p>
<p>The amount of memory a HashJoinBuffer instance can use is limited by the system variable "join_buffer_size". However, note that we check whether we have exceeded the memory limit <em>after</em> we have inserted data into the row buffer. As such, we will probably use a little bit more memory than specified by join_buffer_size.</p>
<p>Some basic profiling shows that the majority of the time is used on constructing the hash table. It would be a future improvement to replace std::unordered_multimap with a more performant hash table, as the literature suggests that there are better alternatives (see e.g. <a href="https://probablydance.com/2017/02/26/i-wrote-the-fastest-hashtable/">https://probablydance.com/2017/02/26/i-wrote-the-fastest-hashtable/</a>).</p>
<p>The primary use case for these classes is, as the name implies, for implementing hash join. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_5bd71961b401a432086d0fb290a87f3f.html">sql</a></li><li class="navelem"><a class="el" href="hash__join__buffer_8h.html">hash_join_buffer.h</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
