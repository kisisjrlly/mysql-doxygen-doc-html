<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MySQL: Writing Replication Tests</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="mysql.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo-mysql-110x55.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MySQL
   &#160;<span id="projectnumber">8.0.22</span>
   </div>
   <div id="projectbrief">Source Code Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('PAGE_WRITING_REPLICATION_TESTS.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Writing Replication Tests </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>If you are writing a replication test case, the test case file should begin with this command:</p>
<pre class="fragment">--source include/master-slave.inc
</pre><p>To switch between the master and slave, use these commands:</p>
<pre class="fragment">connection master;
connection slave;
</pre><p>If you need to do something on an alternative connection, you can use <b>connection master1;</b> for the master and <b>connection slave1;</b> for the slave.</p>
<p>To run the master with additional options for your test case, put them in command-line format in <b>t/<em>test_name-master</em>.opt</b>. When a file named <b>t/<em>test_name-master</em>.opt</b> exists, <a class="el" href="PAGE_MYSQL_TEST_RUN_PL.html">mysql-test-run.pl</a> examines it for extra options that the server needs to be run with when executing the <em>test_name</em> test case. If no server has yet been started or the current server is running with different options, <a class="el" href="PAGE_MYSQL_TEST_RUN_PL.html">mysql-test-run.pl</a> restarts the server with the new options.</p>
<p>For the slave, similar principles apply, but you should list additional options in <b>t/<em>test_name-slave</em>.opt</b>.</p>
<p>Several include files are available for use in tests that enable better control over the behavior of slave server I/O and SQL threads. The files are located in the <b>include</b> directory and have names of the form <b>wait_for_slave_*.inc</b>. By using these files, you can help make replication tests more stable because it will be more likely that test failures are due to replication failures, not due to problems with the tests themselves.</p>
<p>The slave-control include files address the issue that it is not always sufficient to use a <b>START SLAVE</b> or <b>STOP SLAVE</b> statement by itself: When the statement returns, the slave may not have reached the desired operational state. For example, with <b>START SLAVE</b>, the following considerations apply:</p>
<ul>
<li>
<p class="startli">It is not necessary to wait for the SQL thread after <b>START SLAVE</b> or <b>START SLAVE SQL_THREAD</b> because the thread will have started by the time statement returns. </p>
<p class="endli"></p>
</li>
<li>
By contrast, it is necessary to wait for the I/O thread after <b>START SLAVE</b> or <b>START SLAVE IO_THREAD</b> because although the thread will have started when the statement returns, it may not yet have established the connection to the master.  </li>
</ul>
<p>To verify that a slave has reached the desired state, combine the use of <b>START SLAVE</b> or <b>STOP SLAVE</b> with an appropriate “wait” include file. The file contains code that waits until the state has been reached or a timeout occurs. For example, to verify that both slave threads have started, do this:</p>
<pre class="fragment">START SLAVE
--source include/wait_for_slave_to_start.inc
</pre><p>Similarly, to stop both slave threads, do this:</p>
<pre class="fragment">STOP SLAVE;
--source include/wait_for_slave_to_stop.inc
</pre><p>The following list describes the include files that are available for slave control:</p>
<ul>
<li>
<p class="startli"><code>wait_for_slave_to_start.inc</code></p>
<p>Waits for both slave threads (I/O and SQL) to start. Should be preceded by a <b>START SLAVE</b> statement. </p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><code>wait_for_slave_to_stop.inc</code></p>
<p>Waits for both slave threads (I/O and SQL) to stop. Should be preceded by a <b>STOP SLAVE</b> statement. </p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><code>wait_for_slave_sql_to_stop.inc</code></p>
<p>Waits for the slave SQL thread to stop. Should be preceded by a <b>STOP SLAVE SQL_THREAD</b> statement. </p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><code>wait_for_slave_io_to_stop.inc</code></p>
<p>Waits for the slave I/O thread to stop. Should be preceded by a <b>STOP SLAVE IO_THREAD</b> statement. </p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><code>wait_for_slave_param.inc</code></p>
<p>Waits until <b>SHOW SLAVE STATUS</b> output contains a given value or a timeout occurs. Before including the file, you should set the <b>$slave_param</b> variable to the column name to look for in <b>SHOW SLAVE STATUS</b> output, and <b>$slave_param_value</b> to the value that you are waiting for the column to have.</p>
<p>Example:</p>
<pre class="fragment">--let $slave_param= Slave_SQL_Running
--let $slave_param_value= No
--source include/slave_wait_slave_param.inc</pre> <p class="endli"></p>
</li>
<li>
<p class="startli"><code>wait_for_slave_sql_error.inc</code></p>
<p class="endli">Waits until the SQL thread for the current connection has gotten an error or a timeout occurs. Occurrence of an error is determined by waiting for the <b>Last_SQL_Errno</b> column of <b>SHOW SLAVE STATUS</b> output to have a nonzero value.  </p>
</li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="PAGE_TESTING_TOOLS.html">Testing Tools</a></li><li class="navelem"><a class="el" href="PAGE_MYSQL_TEST_RUN.html">The MySQL Test Framework</a></li><li class="navelem"><a class="el" href="PAGE_WRITING_TESTCASES.html">Writing Test Cases</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
