<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MySQL: sql/rpl_record.cc File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="mysql.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo-mysql-110x55.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MySQL
   &#160;<span id="projectnumber">8.0.22</span>
   </div>
   <div id="projectbrief">Source Code Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('rpl__record_8cc.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">rpl_record.cc File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="rpl__record_8h_source.html">sql/rpl_record.h</a>&quot;</code><br />
<code>#include &lt;stddef.h&gt;</code><br />
<code>#include &lt;algorithm&gt;</code><br />
<code>#include &quot;<a class="el" href="field__types_8h_source.html">field_types.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="lex__string_8h_source.html">lex_string.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="m__ctype_8h_source.html">m_ctype.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="m__string_8h_source.html">m_string.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="my__bitmap_8h_source.html">my_bitmap.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="my__compiler_8h_source.html">my_compiler.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="my__dbug_8h_source.html">my_dbug.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="my__sys_8h_source.html">my_sys.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="mysql__com_8h_source.html">mysql_com.h</a>&quot;</code><br />
<code>#include &quot;mysqld_error.h&quot;</code><br />
<code>#include &quot;<a class="el" href="current__thd_8h_source.html">sql/current_thd.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="debug__sync_8h_source.html">sql/debug_sync.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="derror_8h_source.html">sql/derror.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="sql_2field_8h_source.html">sql/field.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="log__event_8h_source.html">sql/log_event.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="rpl__rli_8h_source.html">sql/rpl_rli.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="rpl__utility_8h_source.html">sql/rpl_utility.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="sql__const_8h_source.html">sql/sql_const.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="sql__error_8h_source.html">sql/sql_error.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="system__variables_8h_source.html">sql/system_variables.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="sql_2table_8h_source.html">sql/table.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="sql__string_8h_source.html">sql_string.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="template__utils_8h_source.html">template_utils.h</a>&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ac3160f1894bd522eec9966910b3ce963"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rpl__record_8cc.html#ac3160f1894bd522eec9966910b3ce963">pack_field</a> (<a class="el" href="my__inttypes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> **pack_ptr, <a class="el" href="classField.html">Field</a> *field, size_t rec_offset, <a class="el" href="rpl__record_8h.html#a79d87325ad7c0508d46a8589344ad505">enum_row_image_type</a> row_image_type, <a class="el" href="my__inttypes_8h.html#a22152088aba12c47e916b7f0ffee0f51">ulonglong</a> value_options, <a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a> *is_partial_format)</td></tr>
<tr class="memdesc:ac3160f1894bd522eec9966910b3ce963"><td class="mdescLeft">&#160;</td><td class="mdescRight">Write a single field (column) of a row in a binary log row event to the output.  <a href="#ac3160f1894bd522eec9966910b3ce963">More...</a><br /></td></tr>
<tr class="separator:ac3160f1894bd522eec9966910b3ce963"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afd803f0beecdc90aecb28e5797fbd1e9"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rpl__record_8cc.html#afd803f0beecdc90aecb28e5797fbd1e9">unpack_field</a> (const <a class="el" href="my__inttypes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> **pack_ptr, <a class="el" href="classField.html">Field</a> *field, <a class="el" href="uca-dump_8cc.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="el" href="persisted__variable_8cc.html#a17632c4b396fac52c8df4d4f83af6923">metadata</a>, <a class="el" href="rpl__record_8h.html#a79d87325ad7c0508d46a8589344ad505">enum_row_image_type</a> row_image_type, <a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a> is_partial_column)</td></tr>
<tr class="memdesc:afd803f0beecdc90aecb28e5797fbd1e9"><td class="mdescLeft">&#160;</td><td class="mdescRight">Read a single field (column) of a row from a binary log row event.  <a href="#afd803f0beecdc90aecb28e5797fbd1e9">More...</a><br /></td></tr>
<tr class="separator:afd803f0beecdc90aecb28e5797fbd1e9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4f6d782b081c1fbfb16f18976e6174dd"><td class="memItemLeft" align="right" valign="top">size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rpl__record_8cc.html#a4f6d782b081c1fbfb16f18976e6174dd">pack_row</a> (<a class="el" href="structTABLE.html">TABLE</a> *table, <a class="el" href="structMY__BITMAP.html">MY_BITMAP</a> const *columns_in_image, <a class="el" href="my__inttypes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *row_data, const <a class="el" href="my__inttypes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *<a class="el" href="structrecord.html">record</a>, <a class="el" href="rpl__record_8h.html#a79d87325ad7c0508d46a8589344ad505">enum_row_image_type</a> row_image_type, <a class="el" href="my__inttypes_8h.html#a22152088aba12c47e916b7f0ffee0f51">ulonglong</a> value_options)</td></tr>
<tr class="memdesc:a4f6d782b081c1fbfb16f18976e6174dd"><td class="mdescLeft">&#160;</td><td class="mdescRight">Pack a record of data for a table into a format suitable for the binary log.  <a href="#a4f6d782b081c1fbfb16f18976e6174dd">More...</a><br /></td></tr>
<tr class="separator:a4f6d782b081c1fbfb16f18976e6174dd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a67e5bfe9cdbb230586d6c34cb0b57932"><td class="memItemLeft" align="right" valign="top">static const <a class="el" href="my__inttypes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rpl__record_8cc.html#a67e5bfe9cdbb230586d6c34cb0b57932">start_partial_bit_reader</a> (const <a class="el" href="my__inttypes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *pack_ptr, size_t length, const <a class="el" href="classtable__def.html">table_def</a> *tabledef, <a class="el" href="classBit__reader.html">Bit_reader</a> *partial_bits, <a class="el" href="my__inttypes_8h.html#a22152088aba12c47e916b7f0ffee0f51">ulonglong</a> *event_value_options)</td></tr>
<tr class="memdesc:a67e5bfe9cdbb230586d6c34cb0b57932"><td class="mdescLeft">&#160;</td><td class="mdescRight">Read the value_options from a Partial_update_rows_log_event, and if value_options has any bit set, also read partial_bits.  <a href="#a67e5bfe9cdbb230586d6c34cb0b57932">More...</a><br /></td></tr>
<tr class="separator:a67e5bfe9cdbb230586d6c34cb0b57932"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a79b2a5ecfb335bb58693eb29eab7e7c6"><td class="memItemLeft" align="right" valign="top"><a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rpl__record_8cc.html#a79b2a5ecfb335bb58693eb29eab7e7c6">unpack_row</a> (<a class="el" href="classRelay__log__info.html">Relay_log_info</a> const *rli, <a class="el" href="structTABLE.html">TABLE</a> *table, <a class="el" href="uca-dump_8cc.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> const master_column_count, <a class="el" href="my__inttypes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> const *const row_data, <a class="el" href="structMY__BITMAP.html">MY_BITMAP</a> const *column_image, <a class="el" href="my__inttypes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> const **const row_image_end_p, <a class="el" href="my__inttypes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> const *const event_end, <a class="el" href="rpl__record_8h.html#a79d87325ad7c0508d46a8589344ad505">enum_row_image_type</a> row_image_type, <a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a> event_has_value_options, <a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a> only_seek)</td></tr>
<tr class="memdesc:a79b2a5ecfb335bb58693eb29eab7e7c6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Unpack a row image (either before-image or after-image) into <code>table-&gt;record</code>[0].  <a href="#a79b2a5ecfb335bb58693eb29eab7e7c6">More...</a><br /></td></tr>
<tr class="separator:a79b2a5ecfb335bb58693eb29eab7e7c6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aca6ed840c417f3eda32fc30d4560f737"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rpl__record_8cc.html#aca6ed840c417f3eda32fc30d4560f737">prepare_record</a> (<a class="el" href="structTABLE.html">TABLE</a> *const table, const <a class="el" href="structMY__BITMAP.html">MY_BITMAP</a> *cols, const <a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a> check)</td></tr>
<tr class="memdesc:aca6ed840c417f3eda32fc30d4560f737"><td class="mdescLeft">&#160;</td><td class="mdescRight">Fills <code>table-&gt;record</code>[0] with default values.  <a href="#aca6ed840c417f3eda32fc30d4560f737">More...</a><br /></td></tr>
<tr class="separator:aca6ed840c417f3eda32fc30d4560f737"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="ac3160f1894bd522eec9966910b3ce963"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac3160f1894bd522eec9966910b3ce963">&#9670;&nbsp;</a></span>pack_field()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void pack_field </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="my__inttypes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> **&#160;</td>
          <td class="paramname"><em>pack_ptr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classField.html">Field</a> *&#160;</td>
          <td class="paramname"><em>field</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>rec_offset</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="rpl__record_8h.html#a79d87325ad7c0508d46a8589344ad505">enum_row_image_type</a>&#160;</td>
          <td class="paramname"><em>row_image_type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="my__inttypes_8h.html#a22152088aba12c47e916b7f0ffee0f51">ulonglong</a>&#160;</td>
          <td class="paramname"><em>value_options</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a> *&#160;</td>
          <td class="paramname"><em>is_partial_format</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Write a single field (column) of a row in a binary log row event to the output. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">pack_ptr</td><td>Pointer to buffer where the field will be written. It is the caller's responsibility to have allocated enough memory for this buffer. The pointer will be updated to point to the next byte after the last byte that was written.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">field</td><td>The field to write.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">rec_offset</td><td>Offset to the record that will be written. This is defined by the Field interface: it should be the offset from table-&gt;record[0], of the record passed to ha_[write|update|delete]_row. In other words, 0 if this is a before-image and the size of the before-image record if this is an after-image.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">row_image_type</td><td>The type of image: before-image or after-image, for a Write/Update/Delete event.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">value_options</td><td>The value of @session.binlog_row_value_options</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">is_partial_format</td><td>Will be set to true if this field was written in partial format, otherwise will not be modified. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a4f6d782b081c1fbfb16f18976e6174dd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4f6d782b081c1fbfb16f18976e6174dd">&#9670;&nbsp;</a></span>pack_row()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">size_t pack_row </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structTABLE.html">TABLE</a> *&#160;</td>
          <td class="paramname"><em>table</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structMY__BITMAP.html">MY_BITMAP</a> const *&#160;</td>
          <td class="paramname"><em>columns_in_image</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="my__inttypes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *&#160;</td>
          <td class="paramname"><em>row_data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="my__inttypes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *&#160;</td>
          <td class="paramname"><em>record</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="rpl__record_8h.html#a79d87325ad7c0508d46a8589344ad505">enum_row_image_type</a>&#160;</td>
          <td class="paramname"><em>row_image_type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="my__inttypes_8h.html#a22152088aba12c47e916b7f0ffee0f51">ulonglong</a>&#160;</td>
          <td class="paramname"><em>value_options</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Pack a record of data for a table into a format suitable for the binary log. </p>
<p>The format for a row where N columns are included in the image is the following: </p><pre class="fragment">+-----------+----------+----------+     +----------+
| null_bits | column_1 | column_2 | ... | column_N |
+-----------+----------+----------+     +----------+
</pre><p>Where</p>
<ul>
<li>null_bits is a bitmap using ceil(N/8) bytes. There is one bit for every column included in the image, <em>regardless of whether it can be null or not</em>. The number of null bits is equal to the number of bits set in the <code>columns_in_image</code> bitmap.</li>
<li>column_i: Each of the N columns is stored in a format that depends on the type of the column.</li>
</ul>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">table</td><td>Table describing the format of the record</td></tr>
    <tr><td class="paramname">columns_in_image</td><td>Bitmap with a set bit for each column that should be stored in the row.</td></tr>
    <tr><td class="paramname">row_data</td><td>Pointer to memory where row will be written</td></tr>
    <tr><td class="paramname">record</td><td>Pointer to record retrieved from the engine.</td></tr>
    <tr><td class="paramname">row_image_type</td><td>The type of image: before-image or after-image, for a Write/Update/Delete event.</td></tr>
    <tr><td class="paramname">value_options</td><td>The value of @session.binlog_row_value_options</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>The number of bytes written at <code>row_data</code>. </dd></dl>

</div>
</div>
<a id="aca6ed840c417f3eda32fc30d4560f737"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aca6ed840c417f3eda32fc30d4560f737">&#9670;&nbsp;</a></span>prepare_record()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int prepare_record </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structTABLE.html">TABLE</a> *const&#160;</td>
          <td class="paramname"><em>table</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structMY__BITMAP.html">MY_BITMAP</a> *&#160;</td>
          <td class="paramname"><em>cols</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a>&#160;</td>
          <td class="paramname"><em>check</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Fills <code>table-&gt;record</code>[0] with default values. </p>
<p>First <code>restore_record()</code> is called to restore the default values for the record concerning the given table. Then, if <code>check</code> is true, a check is performed to see if fields have the default value or can be NULL. Otherwise an error is reported.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">table</td><td>Table whose record[0] buffer is prepared. </td></tr>
    <tr><td class="paramname">cols</td><td>bitmap with a set bit for each column that should be stored in a row. </td></tr>
    <tr><td class="paramname">check</td><td>Specifies if lack of default error needs checking.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on success or a handler level error code </dd></dl>
<p>Save a reference to the original write set bitmaps. We will need this to restore the bitmaps at the end.</p>
<p>Just to be sure that tmp_set is currently not in use as the write_set already.</p>
<p>Set table-&gt;write_set bits for all the columns as they will be checked in set_default() function.</p>

</div>
</div>
<a id="a67e5bfe9cdbb230586d6c34cb0b57932"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a67e5bfe9cdbb230586d6c34cb0b57932">&#9670;&nbsp;</a></span>start_partial_bit_reader()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static const <a class="el" href="my__inttypes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>* start_partial_bit_reader </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="my__inttypes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *&#160;</td>
          <td class="paramname"><em>pack_ptr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>length</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="classtable__def.html">table_def</a> *&#160;</td>
          <td class="paramname"><em>tabledef</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classBit__reader.html">Bit_reader</a> *&#160;</td>
          <td class="paramname"><em>partial_bits</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="my__inttypes_8h.html#a22152088aba12c47e916b7f0ffee0f51">ulonglong</a> *&#160;</td>
          <td class="paramname"><em>event_value_options</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Read the value_options from a Partial_update_rows_log_event, and if value_options has any bit set, also read partial_bits. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">pack_ptr</td><td>Read position before the value_options.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">length</td><td>Number of bytes between pack_ptr and the end of the event.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tabledef</td><td>Table definition according to previous Table_map_log_event.</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">partial_bits</td><td>If the event has partial_bits, initialize the read position of this Bit_reader to the position of the partial_bits.</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">event_value_options</td><td>The value of the value_options field found in the event.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>The read position after value_options and partial_bits (if partial_bits is present). </dd></dl>

</div>
</div>
<a id="afd803f0beecdc90aecb28e5797fbd1e9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afd803f0beecdc90aecb28e5797fbd1e9">&#9670;&nbsp;</a></span>unpack_field()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a> unpack_field </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="my__inttypes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> **&#160;</td>
          <td class="paramname"><em>pack_ptr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classField.html">Field</a> *&#160;</td>
          <td class="paramname"><em>field</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="uca-dump_8cc.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>&#160;</td>
          <td class="paramname"><em>metadata</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="rpl__record_8h.html#a79d87325ad7c0508d46a8589344ad505">enum_row_image_type</a>&#160;</td>
          <td class="paramname"><em>row_image_type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a>&#160;</td>
          <td class="paramname"><em>is_partial_column</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Read a single field (column) of a row from a binary log row event. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">pack_ptr</td><td>Pointer to buffer where the field is stored. The pointer will be updated to point to the next byte after the last byte that was read.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">field</td><td>The field to read.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">metadata</td><td>The so-called 'metadata' for the field. The meaning of this may differ depending on the SQL type. But typically, it is the length of the field that holds the length of the value: e.g. it is 1 for TINYBLOB, 2 for BLOB, 3 for MEDIUMBLOB, and 4 for LARGEBLOB.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">row_image_type</td><td>The type of image: before-image or after-image, for a Write/Update/Delete event.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">is_partial_column</td><td>true if this column is in partial format, false otherwise. (This should be determined by the caller from the event_type (PARTIAL_UPDATE_ROWS_EVENT), row_image_type (UPDATE_AI), value_options (PARTIAL_JSON), and partial_bits (1 for this column)).</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">false</td><td>Success.</td></tr>
    <tr><td class="paramname">true</td><td>Error. Error can happen when reading in partial format and it fails to apply the diff. The error has already been reported through my_error. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a79b2a5ecfb335bb58693eb29eab7e7c6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a79b2a5ecfb335bb58693eb29eab7e7c6">&#9670;&nbsp;</a></span>unpack_row()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a> unpack_row </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classRelay__log__info.html">Relay_log_info</a> const *&#160;</td>
          <td class="paramname"><em>rli</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structTABLE.html">TABLE</a> *&#160;</td>
          <td class="paramname"><em>table</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="uca-dump_8cc.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> const&#160;</td>
          <td class="paramname"><em>master_column_count</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="my__inttypes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> const *const&#160;</td>
          <td class="paramname"><em>row_data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structMY__BITMAP.html">MY_BITMAP</a> const *&#160;</td>
          <td class="paramname"><em>column_image</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="my__inttypes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> const **const&#160;</td>
          <td class="paramname"><em>row_image_end_p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="my__inttypes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> const *const&#160;</td>
          <td class="paramname"><em>event_end</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="rpl__record_8h.html#a79d87325ad7c0508d46a8589344ad505">enum_row_image_type</a>&#160;</td>
          <td class="paramname"><em>row_image_type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a>&#160;</td>
          <td class="paramname"><em>event_has_value_options</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a>&#160;</td>
          <td class="paramname"><em>only_seek</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Unpack a row image (either before-image or after-image) into <code>table-&gt;record</code>[0]. </p>
<p>The row is assumed to only consist of the fields for which the corresponding bit in bitset <code>column_image</code> is set; the other parts of the record are left alone.</p>
<p>If the slave table has more columns than the master table, then the extra columns are not touched by this function. If the master table has more columns than the slave table, then the position is moved to after the extra columns, but the values are not used.</p>
<ul>
<li><p class="startli">The layout of a row is:</p>
<p class="startli">For WRITE_ROWS_EVENT: +-----&mdash;&mdash;&mdash;+ | after-image | +-----&mdash;&mdash;&mdash;+</p>
<p class="startli">For DELETE_ROWS_EVENT: +-----&mdash;&mdash;&mdash;+ | before-image | +-----&mdash;&mdash;&mdash;+</p>
<p class="startli">For UPDATE_ROWS_EVENT: +-----&mdash;&mdash;&mdash;+----&mdash;&mdash;&mdash;+ | before-image | after-image | +-----&mdash;&mdash;&mdash;+----&mdash;&mdash;&mdash;+</p>
<p class="startli">For PARTIAL_UPDATE_ROWS_EVENT: +-----&mdash;&mdash;&mdash;+-----&mdash;&mdash;&mdash;+----&mdash;&mdash;&mdash;+ | before-image | shared-image | after-image | +-----&mdash;&mdash;&mdash;+-----&mdash;&mdash;&mdash;+----&mdash;&mdash;&mdash;+</p>
</li>
<li>Each of before-image and after-image has the following format: +&ndash;&mdash;&mdash;+-&mdash;&mdash;+-&mdash;&mdash;+ +-&mdash;&mdash;+ | length | col_1 | col_2 | ... | col_N | +&ndash;&mdash;&mdash;+-&mdash;&mdash;+-&mdash;&mdash;+ +-&mdash;&mdash;+ length is a 4-byte integer in little-endian format, equal to the total length in bytes of col_1, col_2, ..., col_N.</li>
<li>The shared-image has one of the following formats: +--------&mdash;&mdash;&mdash;+ | value_options=0 | +--------&mdash;&mdash;&mdash;+ or +--------&mdash;&mdash;&mdash;+-----&mdash;&mdash;&mdash;+ | value_options=1 | partial_bits | +--------&mdash;&mdash;&mdash;+-----&mdash;&mdash;&mdash;+ where:<ul>
<li>value_options is a bitmap, stored as an integer, in the format of net_field_length. Currently only one bit is allowed: 1=PARTIAL_JSON_UPDATES (so therefore the integer is always 0 or 1, so in reality value_options is only one byte). When PARTIAL_JSON_UPDATES=0, there is nothing else in the shared-image. When PARTIAL_JSON_UPDATES=1, there is a partial_bits field.</li>
<li>partial_bits has one bit for each <em>JSON</em> column in the table (regardless of whether it is included in the before-image and/or after-image). The bit is 0 if the JSON update is stored as a full document in the after-image, and 1 if the JSON update in partial form in the after-image.</li>
<li><p class="startli">Both when reading the before-image and when reading the after-image it is necessary to know the partialness of JSON columns: when reading the before-image, before looking up the row in the table, we need to set the column in the table's 'read_set' (even if the column was not in the before-image), in order to guarantee that the storage engine reads that column, so that there is any base document that the diff can be applied on. When reading the after-image, we need to know which columns are partial so that we can correctly parse the data for that column.</p>
<p class="startli">Therefore, when this function parses the before-image of a PARTIAL_UPDATE_ROWS_LOG_EVENT, it reads both the before-image and the shared-image, but leaves the read position after the before-image. So when it parses the after-image of a PARTIAL_UPDATE_ROWS_LOG_EVENT, the read position is at the beginning of the shared-image, so it parses both the shared-image and the after-image.</p>
</li>
</ul>
</li>
</ul>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">rli</td><td>Applier execution context</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">table</td><td>Table to unpack into</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">master_column_count</td><td>Number of columns that the master had in its table</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">row_data</td><td>Beginning of the row image</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">column_image</td><td>Pointer to a bit vector where the N'th bit is 0 for columns that are not included in the event, and 1 for columns that are included in the event.</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">row_image_end_p</td><td>If this function returns successfully, it sets row_image_end to point to the next byte after the row image that it has read.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">event_end</td><td>Pointer to the end of the event.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">row_image_type</td><td>The type of row image that we are going to read: WRITE_AI, UPDATE_BI, UPDATE_AI, or DELETE_BI.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">event_has_value_options</td><td>true for PARTIAL_UPDATE_ROWS_EVENT, false for UPDATE_ROWS_EVENT.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">only_seek</td><td>If true, this is a seek operation rather than a read operation. It will only compute the row_image_end_p pointer, and not read anything into the table and not apply any JSON diffs. (This is used in slave_rows_search_algorithms=HASH_SCAN, which (1) unpacks and hashes the before-image for all rows in the event, (2) scans the table, and for each matching row it (3) unpacks the after-image and applies on the table. In step (1) it needs to unpack the after-image too, in order to move the read position forwards, and then it should use only_seek=true. This is an optimization, but more importantly, when the after-image contains partial JSON, the partial JSON cannot be applied in step (1) since there is no JSON document to apply it on.)</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>false on success, true on error. </dd></dl>
<p>Calling reset just in case one is unpacking on top a record with data.</p>
<p>This could probably go into set_null() but doing so, (i) triggers assertion in other parts of the code at the moment; (ii) it would make us reset the field, always when setting null, which right now doesn't seem needed anywhere else except here.</p>
<p>TODO: maybe in the future we should consider moving the reset to make it part of set_null. But then the assertions triggered need to be addressed/revisited.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_5bd71961b401a432086d0fb290a87f3f.html">sql</a></li><li class="navelem"><a class="el" href="rpl__record_8cc.html">rpl_record.cc</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
