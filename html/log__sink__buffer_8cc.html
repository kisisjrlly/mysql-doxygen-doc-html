<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MySQL: sql/server_component/log_sink_buffer.cc File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="mysql.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo-mysql-110x55.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MySQL
   &#160;<span id="projectnumber">8.0.22</span>
   </div>
   <div id="projectbrief">Source Code Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('log__sink__buffer_8cc.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">log_sink_buffer.cc File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>This file contains.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="log__sink__buffer_8h_source.html">log_sink_buffer.h</a>&quot;</code><br />
<code>#include &lt;<a class="el" href="log__shared_8h_source.html">mysql/components/services/log_shared.h</a>&gt;</code><br />
<code>#include &quot;<a class="el" href="log__builtins__filter__imp_8h_source.html">log_builtins_filter_imp.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="log__sink__trad_8h_source.html">log_sink_trad.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="my__systime_8h_source.html">my_systime.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="log_8h_source.html">sql/log.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="psi__memory__key_8h_source.html">sql/psi_memory_key.h</a>&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structlog__line__buffer.html">log_line_buffer</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a8e4962441edbddfc2644d3dacfc0f8e0"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__buffer_8cc.html#a8e4962441edbddfc2644d3dacfc0f8e0">LOG_BUFFERING_TIMEOUT_AFTER</a>&#160;&#160;&#160;(60)</td></tr>
<tr class="memdesc:a8e4962441edbddfc2644d3dacfc0f8e0"><td class="mdescLeft">&#160;</td><td class="mdescRight">If after this many seconds we're still buffering, flush!  <a href="#a8e4962441edbddfc2644d3dacfc0f8e0">More...</a><br /></td></tr>
<tr class="separator:a8e4962441edbddfc2644d3dacfc0f8e0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a734285de616949e291f30e3abc837521"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__buffer_8cc.html#a734285de616949e291f30e3abc837521">LOG_BUFFERING_TIMEOUT_EVERY</a>&#160;&#160;&#160;(10)</td></tr>
<tr class="memdesc:a734285de616949e291f30e3abc837521"><td class="mdescLeft">&#160;</td><td class="mdescRight">Thereafter, if still buffering after this many more seconds, flush again!  <a href="#a734285de616949e291f30e3abc837521">More...</a><br /></td></tr>
<tr class="separator:a734285de616949e291f30e3abc837521"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aed77bb5a08c2e553dbb069b557d6fc57"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__buffer_8cc.html#aed77bb5a08c2e553dbb069b557d6fc57">LOG_BUFFERING_TIME_SCALE</a>&#160;&#160;&#160;1000000</td></tr>
<tr class="memdesc:aed77bb5a08c2e553dbb069b557d6fc57"><td class="mdescLeft">&#160;</td><td class="mdescRight">Time function returns microseconds, we want seconds.  <a href="#aed77bb5a08c2e553dbb069b557d6fc57">More...</a><br /></td></tr>
<tr class="separator:aed77bb5a08c2e553dbb069b557d6fc57"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ac2791a9d33f4fb9186cd3889b8859ba0"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__buffer_8cc.html#ac2791a9d33f4fb9186cd3889b8859ba0">log_line_duplicate</a> (<a class="el" href="log__shared_8h.html#abef61f7610a42c29cd8b3a92f391143f">log_line</a> *dst, <a class="el" href="log__shared_8h.html#abef61f7610a42c29cd8b3a92f391143f">log_line</a> *src)</td></tr>
<tr class="memdesc:ac2791a9d33f4fb9186cd3889b8859ba0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Duplicate a log-event.  <a href="#ac2791a9d33f4fb9186cd3889b8859ba0">More...</a><br /></td></tr>
<tr class="separator:ac2791a9d33f4fb9186cd3889b8859ba0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a216407f8dcaa5ae843066fd8259ce70a"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__buffer_8cc.html#a216407f8dcaa5ae843066fd8259ce70a">log_sink_buffer</a> (void *instance, <a class="el" href="log__shared_8h.html#abef61f7610a42c29cd8b3a92f391143f">log_line</a> *ll)</td></tr>
<tr class="memdesc:a216407f8dcaa5ae843066fd8259ce70a"><td class="mdescLeft">&#160;</td><td class="mdescRight">services: log sinks: buffered logging  <a href="#a216407f8dcaa5ae843066fd8259ce70a">More...</a><br /></td></tr>
<tr class="separator:a216407f8dcaa5ae843066fd8259ce70a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a50fc401bc5709e109957d4b2464f29ba"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__buffer_8cc.html#a50fc401bc5709e109957d4b2464f29ba">log_sink_buffer_check_timeout</a> (void)</td></tr>
<tr class="memdesc:a50fc401bc5709e109957d4b2464f29ba"><td class="mdescLeft">&#160;</td><td class="mdescRight">Convenience function.  <a href="#a50fc401bc5709e109957d4b2464f29ba">More...</a><br /></td></tr>
<tr class="separator:a50fc401bc5709e109957d4b2464f29ba"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5743494132998ba89241f24691a6aa21"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__buffer_8cc.html#a5743494132998ba89241f24691a6aa21">log_sink_buffer_flush</a> (enum <a class="el" href="log__sink__buffer_8h.html#a5a9c85d36e64f53662a7f430146b009f">log_sink_buffer_flush_mode</a> mode)</td></tr>
<tr class="memdesc:a5743494132998ba89241f24691a6aa21"><td class="mdescLeft">&#160;</td><td class="mdescRight">Process all buffered log-events.  <a href="#a5743494132998ba89241f24691a6aa21">More...</a><br /></td></tr>
<tr class="separator:a5743494132998ba89241f24691a6aa21"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a945317b0c79ceed47fd4b1b1b79bfd02"><td class="memItemLeft" align="right" valign="top"><a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__buffer_8cc.html#a945317b0c79ceed47fd4b1b1b79bfd02">log_builtins_inited</a></td></tr>
<tr class="memdesc:a945317b0c79ceed47fd4b1b1b79bfd02"><td class="mdescLeft">&#160;</td><td class="mdescRight">Subsystem initialized and ready to use?  <a href="#a945317b0c79ceed47fd4b1b1b79bfd02">More...</a><br /></td></tr>
<tr class="separator:a945317b0c79ceed47fd4b1b1b79bfd02"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a384c1fb529a0d4cbc788bc35a1b94fcc"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structmysql__mutex__t.html">mysql_mutex_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__buffer_8cc.html#a384c1fb529a0d4cbc788bc35a1b94fcc">THR_LOCK_log_buffered</a></td></tr>
<tr class="memdesc:a384c1fb529a0d4cbc788bc35a1b94fcc"><td class="mdescLeft">&#160;</td><td class="mdescRight">Make sure only one instance of the buffered "writer" runs at a time.  <a href="#a384c1fb529a0d4cbc788bc35a1b94fcc">More...</a><br /></td></tr>
<tr class="separator:a384c1fb529a0d4cbc788bc35a1b94fcc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5b07a39f036a10a339d04ab99dd6730c"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="structlog__line__buffer.html">log_line_buffer</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__buffer_8cc.html#a5b07a39f036a10a339d04ab99dd6730c">log_line_buffer_start</a> = <a class="el" href="auth__ldap__sasl__client_8cc.html#ae7bd12bd7c9e418a420087971d0a7e31">nullptr</a></td></tr>
<tr class="memdesc:a5b07a39f036a10a339d04ab99dd6730c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Pointer to the first element in the list of buffered log messages.  <a href="#a5b07a39f036a10a339d04ab99dd6730c">More...</a><br /></td></tr>
<tr class="separator:a5b07a39f036a10a339d04ab99dd6730c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5fad794b75a2426a68bea28bce03bec0"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="structlog__line__buffer.html">log_line_buffer</a> **&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__buffer_8cc.html#a5fad794b75a2426a68bea28bce03bec0">log_line_buffer_tail</a> = &amp;<a class="el" href="log__sink__buffer_8cc.html#a5b07a39f036a10a339d04ab99dd6730c">log_line_buffer_start</a></td></tr>
<tr class="memdesc:a5fad794b75a2426a68bea28bce03bec0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Where to write the pointer to the newly-created tail-element of the list.  <a href="#a5fad794b75a2426a68bea28bce03bec0">More...</a><br /></td></tr>
<tr class="separator:a5fad794b75a2426a68bea28bce03bec0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3588dfd2be0804bb13047b0c3aab9086"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="my__inttypes_8h.html#a22152088aba12c47e916b7f0ffee0f51">ulonglong</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__buffer_8cc.html#a3588dfd2be0804bb13047b0c3aab9086">log_buffering_timeout</a> = 0</td></tr>
<tr class="memdesc:a3588dfd2be0804bb13047b0c3aab9086"><td class="mdescLeft">&#160;</td><td class="mdescRight">Timestamp: During buffered logging, when should we next consider flushing? This variable is set to the time we'll next check whether we'll want to flush buffered log events.  <a href="#a3588dfd2be0804bb13047b0c3aab9086">More...</a><br /></td></tr>
<tr class="separator:a3588dfd2be0804bb13047b0c3aab9086"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aadd25abc8da9150fe606bfe90e74585e"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__buffer_8cc.html#aadd25abc8da9150fe606bfe90e74585e">log_buffering_flushworthy</a> = <a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#a65e9886d74aaee76545e83dd09011727">false</a></td></tr>
<tr class="memdesc:aadd25abc8da9150fe606bfe90e74585e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Does buffer contain SYSTEM or ERROR prio messages? Flush early only then!  <a href="#aadd25abc8da9150fe606bfe90e74585e">More...</a><br /></td></tr>
<tr class="separator:aadd25abc8da9150fe606bfe90e74585e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0bfae681da5f616ce1afd9de3bb66ae7"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="my__inttypes_8h.html#a22152088aba12c47e916b7f0ffee0f51">ulonglong</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__buffer_8cc.html#a0bfae681da5f616ce1afd9de3bb66ae7">log_sink_buffer_last</a> = 0</td></tr>
<tr class="memdesc:a0bfae681da5f616ce1afd9de3bb66ae7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Timestamp of the last event we put into the error-log buffer during buffered mode (while starting up).  <a href="#a0bfae681da5f616ce1afd9de3bb66ae7">More...</a><br /></td></tr>
<tr class="separator:a0bfae681da5f616ce1afd9de3bb66ae7"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>This file contains. </p>
<p>a) the log-sink that buffers errors logged during start-up so they can be flushed once all configured log-components have become available;</p>
<p>b) the functions for querying and setting the phase the server is in with regard to logging (buffering, normal operation, and so forth);</p>
<p>c) the functions for flushing the buffered information (to force writing out this information in cases of early shutdowns and so on). </p>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a id="aed77bb5a08c2e553dbb069b557d6fc57"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aed77bb5a08c2e553dbb069b557d6fc57">&#9670;&nbsp;</a></span>LOG_BUFFERING_TIME_SCALE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define LOG_BUFFERING_TIME_SCALE&#160;&#160;&#160;1000000</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Time function returns microseconds, we want seconds. </p>

</div>
</div>
<a id="a8e4962441edbddfc2644d3dacfc0f8e0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8e4962441edbddfc2644d3dacfc0f8e0">&#9670;&nbsp;</a></span>LOG_BUFFERING_TIMEOUT_AFTER</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define LOG_BUFFERING_TIMEOUT_AFTER&#160;&#160;&#160;(60)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>If after this many seconds we're still buffering, flush! </p>

</div>
</div>
<a id="a734285de616949e291f30e3abc837521"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a734285de616949e291f30e3abc837521">&#9670;&nbsp;</a></span>LOG_BUFFERING_TIMEOUT_EVERY</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define LOG_BUFFERING_TIMEOUT_EVERY&#160;&#160;&#160;(10)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Thereafter, if still buffering after this many more seconds, flush again! </p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="ac2791a9d33f4fb9186cd3889b8859ba0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac2791a9d33f4fb9186cd3889b8859ba0">&#9670;&nbsp;</a></span>log_line_duplicate()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a> log_line_duplicate </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="log__shared_8h.html#abef61f7610a42c29cd8b3a92f391143f">log_line</a> *&#160;</td>
          <td class="paramname"><em>dst</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="log__shared_8h.html#abef61f7610a42c29cd8b3a92f391143f">log_line</a> *&#160;</td>
          <td class="paramname"><em>src</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Duplicate a log-event. </p>
<p>This is a deep copy where the items (key/value pairs) have their own allocated memory separate from that in the source item.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">dst</td><td>log_line that will hold the copy </td></tr>
    <tr><td class="paramname">src</td><td>log_line we copy from</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">false</td><td>on success </td></tr>
    <tr><td class="paramname">true</td><td>if out of memory </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a216407f8dcaa5ae843066fd8259ce70a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a216407f8dcaa5ae843066fd8259ce70a">&#9670;&nbsp;</a></span>log_sink_buffer()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int log_sink_buffer </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>instance</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="log__shared_8h.html#abef61f7610a42c29cd8b3a92f391143f">log_line</a> *&#160;</td>
          <td class="paramname"><em>ll</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>services: log sinks: buffered logging </p>
<p>Write a log-event to the buffer sink.</p>
<p>During start-up, we buffer log-info until a) we have basic info for the built-in logger (what file to log to, verbosity, and so on), and b) advanced info (any logging components to load, any configuration for them, etc.).</p>
<p>As a failsafe, if start-up takes very, very long, and a time-out is reached before reaching b) and we actually have something worth reporting (e.g. errors, as opposed to info), we try to keep the user informed by using the basic logger configured in a), while going on buffering all info and flushing it to any advanced loggers when b) is reached.</p>
<p>1) This function checks and, if needed, updates the time-out, and calls the flush functions as needed. It is internal to the logger and should not be called from elsewhere.</p>
<p>2) Function will save log-event (if given) for later filtering and output.</p>
<p>3) Function acquires/releases THR_LOCK_log_buffered if initialized.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">instance</td><td>instance handle Not currently used in this writer; if this changes later, keep in mind that nullptr will be passed if this is called before the structured logger's locks are initialized, so that must remain a valid argument! </td></tr>
    <tr><td class="paramname">ll</td><td>The log line to write, or nullptr to not add a new logline, but to just check whether the time-out has been reached and if so, flush as needed.</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">-1</td><td>can not add event to buffer (OOM?) </td></tr>
    <tr><td class="paramname">&gt;0</td><td>number of added fields </td></tr>
  </table>
  </dd>
</dl>
<p>&lt; log-line buffer </p>

</div>
</div>
<a id="a50fc401bc5709e109957d4b2464f29ba"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a50fc401bc5709e109957d4b2464f29ba">&#9670;&nbsp;</a></span>log_sink_buffer_check_timeout()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void log_sink_buffer_check_timeout </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Convenience function. </p>
<p>Same as log_sink_buffer(), except we only check whether the time-out for buffered logging has been reached during start-up, and act accordingly; no new logging information is added (i.e., we only provide functionality 1 described in the preamble for log_sink_buffer() above). </p>

</div>
</div>
<a id="a5743494132998ba89241f24691a6aa21"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5743494132998ba89241f24691a6aa21">&#9670;&nbsp;</a></span>log_sink_buffer_flush()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void log_sink_buffer_flush </td>
          <td>(</td>
          <td class="paramtype">enum <a class="el" href="log__sink__buffer_8h.html#a5a9c85d36e64f53662a7f430146b009f">log_sink_buffer_flush_mode</a>&#160;</td>
          <td class="paramname"><em>mode</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Process all buffered log-events. </p>
<p>Release all buffered log-events (discard_error_log_messages()), optionally after running them through the error log stack first (flush_error_log_messages()).</p>
<p>LOG_BUFFER_DISCARD_ONLY simply releases all buffered log-events (used when called from discard_error_log_messages()).</p>
<p>LOG_BUFFER_PROCESS_AND_DISCARD sends the events through the configured error log stack first before discarding them. (used when called from flush_error_log_messages()). Must remain safe to call repeatedly (with subsequent calls only outputting any events added after the previous flush).</p>
<p>LOG_BUFFER_REPORT_AND_KEEP is used to show incremental status updates when the start-up takes unusually long. When that happens, we "report" the intermediate state using the built-in sink (as that's the only one we available to us at the time), and "keep" the events around. That way if log sinks other that the built-in one are configured, we can flush all of the buffered events there once initialization completes. (used when log_sink_buffer() detects a time-out, see also: LOG_BUFFERING_TIMEOUT_AFTER, LOG_BUFFERING_TIMEOUT_EVERY)</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">mode</td><td>LOG_BUFFER_DISCARD_ONLY (to just throw away the buffered events), or LOG_BUFFER_PROCESS_AND_DISCARD to filter/print them first, or LOG_BUFFER_REPORT_AND_KEEP to print an intermediate report on time-out.</td></tr>
  </table>
  </dd>
</dl>
<p>To use LOG_BUFFER_REPORT_AND_KEEP in a multi-threaded environment, the caller needs to hold THR_LOCK_log_buffered while calling this; for the other modes, this function will acquire and release the lock as needed; in this second scenario, the lock will not be held while calling log_services (via log_line_submit()). </p>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="aadd25abc8da9150fe606bfe90e74585e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aadd25abc8da9150fe606bfe90e74585e">&#9670;&nbsp;</a></span>log_buffering_flushworthy</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int log_buffering_flushworthy = <a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#a65e9886d74aaee76545e83dd09011727">false</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Does buffer contain SYSTEM or ERROR prio messages? Flush early only then! </p>

</div>
</div>
<a id="a3588dfd2be0804bb13047b0c3aab9086"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3588dfd2be0804bb13047b0c3aab9086">&#9670;&nbsp;</a></span>log_buffering_timeout</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="my__inttypes_8h.html#a22152088aba12c47e916b7f0ffee0f51">ulonglong</a> log_buffering_timeout = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Timestamp: During buffered logging, when should we next consider flushing? This variable is set to the time we'll next check whether we'll want to flush buffered log events. </p>
<p>I.e. it is set to a future time (current time + window length); once the value expires (turns into present/past), we check whether we need to flush and update the variable to the next time we should check. </p>

</div>
</div>
<a id="a945317b0c79ceed47fd4b1b1b79bfd02"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a945317b0c79ceed47fd4b1b1b79bfd02">&#9670;&nbsp;</a></span>log_builtins_inited</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a> log_builtins_inited</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Subsystem initialized and ready to use? </p>

</div>
</div>
<a id="a5b07a39f036a10a339d04ab99dd6730c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5b07a39f036a10a339d04ab99dd6730c">&#9670;&nbsp;</a></span>log_line_buffer_start</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structlog__line__buffer.html">log_line_buffer</a>* log_line_buffer_start = <a class="el" href="auth__ldap__sasl__client_8cc.html#ae7bd12bd7c9e418a420087971d0a7e31">nullptr</a></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Pointer to the first element in the list of buffered log messages. </p>

</div>
</div>
<a id="a5fad794b75a2426a68bea28bce03bec0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5fad794b75a2426a68bea28bce03bec0">&#9670;&nbsp;</a></span>log_line_buffer_tail</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structlog__line__buffer.html">log_line_buffer</a>** log_line_buffer_tail = &amp;<a class="el" href="log__sink__buffer_8cc.html#a5b07a39f036a10a339d04ab99dd6730c">log_line_buffer_start</a></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Where to write the pointer to the newly-created tail-element of the list. </p>

</div>
</div>
<a id="a0bfae681da5f616ce1afd9de3bb66ae7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0bfae681da5f616ce1afd9de3bb66ae7">&#9670;&nbsp;</a></span>log_sink_buffer_last</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="my__inttypes_8h.html#a22152088aba12c47e916b7f0ffee0f51">ulonglong</a> log_sink_buffer_last = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Timestamp of the last event we put into the error-log buffer during buffered mode (while starting up). </p>
<p>New items must receive a LOG_ITEM_LOG_BUFFERED timestamp greater than this. </p>

</div>
</div>
<a id="a384c1fb529a0d4cbc788bc35a1b94fcc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a384c1fb529a0d4cbc788bc35a1b94fcc">&#9670;&nbsp;</a></span>THR_LOCK_log_buffered</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structmysql__mutex__t.html">mysql_mutex_t</a> THR_LOCK_log_buffered</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Make sure only one instance of the buffered "writer" runs at a time. </p>
<p>In normal operation, the log-event will be created dynamically, then it will be fed through the pipeline, and then it will be released. Since the event is allocated in the caller, we can be sure it won't go away wholesale during processing, and since the event is local to the caller, no other thread will tangle with it. It is therefore safe in those cases not to wrap a lock around the event. (The log-pipeline will still grab a shared lock, THR_LOCK_log_stack, to protect the pipeline (not the event) and the log-services cache from being changed while the pipeline is being applied. Likewise, log-services may protect their resources (file-writers will usually take a lock to serialize their writes; the built-in filter will take a lock on its rule-set as that is shared between concurrent threads running the filter, and so on). None of these are intended to protect the event itself though.</p>
<p>In buffered mode on the other hand, we copy each log-event (the original of which, see above, is owned by the caller and local to the thread, and therefore safe without locking) to a global buffer / backlog. As this backlog can be added to by all threads, it must be protected by a lock (once we have fully initialized the subsystem with log_builtins_init() and support multi-threaded mode anyway, as indicated by log_builtins_inited being true, see below). This is that lock. </p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_5bd71961b401a432086d0fb290a87f3f.html">sql</a></li><li class="navelem"><a class="el" href="dir_12a5ab756a4de267189eabf05ec2ce08.html">server_component</a></li><li class="navelem"><a class="el" href="log__sink__buffer_8cc.html">log_sink_buffer.cc</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
