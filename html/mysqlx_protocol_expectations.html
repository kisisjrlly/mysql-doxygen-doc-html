<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MySQL: Expectations</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="mysql.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo-mysql-110x55.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MySQL
   &#160;<span id="projectnumber">8.0.22</span>
   </div>
   <div id="projectbrief">Source Code Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('mysqlx_protocol_expectations.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Expectations </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Topics in this section:</p>
<ul>
<li><a class="el" href="mysqlx_protocol_expectations.html#expectations_Setting_Expectations">Setting Expectations </a></li>
<li><a class="el" href="mysqlx_protocol_expectations.html#expectations_Behavior">Behavior </a></li>
<li><a class="el" href="mysqlx_protocol_expectations.html#expectations_Conditions">Conditions </a></li>
</ul>
<p>With the use of pipelining in the X Protocol (sending messages without waiting for successful response) only so many messages can be pipelined without causing havoc if one of the pipelined, dependent messages fails:</p>
<div class="fragment"><div class="line">Mysqlx.Crud::PrepareFind(stmt_id=1, ...) // may fail</div><div class="line">Mysqlx.PreparedStmt::Execute(stmt_id=1, ...) // would fail implicitly as stmt_id=1 doesn&#39;t exist</div><div class="line">Mysqlx.PreparedStmt::Close(stmt_id=1) // would fail implicitly as stmt_id=1 doesn&#39;t exist</div></div><!-- fragment --><p>While implicitly failing is one thing, there are situations where it isn't that obvious what will happen:</p>
<div class="fragment"><div class="line">Mysqlx.Crud::PrepareInsert(stmt_id=1, ...) // ok</div><div class="line">Mysqlx.PreparedStmt::Execute(stmt_id=1, ...) // ok</div><div class="line">Mysqlx.PreparedStmt::Execute(stmt_id=1, ...) // duplicate key error</div><div class="line">Mysqlx.PreparedStmt::Execute(stmt_id=1, ...) // what now? abort the insert? ignore?</div><div class="line">Mysqlx.PreparedStmt::Close(stmt_id=1) // close the stmt_id</div></div><!-- fragment --><h1><a class="anchor" id="expectations_Setting_Expectations"></a>
Setting Expectations </h1>
<p>Expectations let statements fail reliably until the end of the block.</p>
<p>Assume the <code>PrepareFind</code> fails:</p>
<ul>
<li>don't execute the <code>Execute</code></li>
<li>don't try to close the stmt</li>
</ul>
<div class="fragment"><div class="line">Mysqlx.Expect::Open([+no_error])</div><div class="line">Mysqlx.Crud::PrepareFind(stmt_id=1, ...) // may fail</div><div class="line">Mysqlx.PreparedStmt::Execute(stmt_id=1, ...) // expectation(no_error) failed</div><div class="line">Mysqlx.PreparedStmt::Close(stmt_id=1) // expectation(no_error) failed</div><div class="line">Mysqlx.Expect::Close()</div></div><!-- fragment --><p>But this would also skip the close if execute fails. Not what we want. Adding another expect-block handles it:</p>
<div class="fragment"><div class="line">Mysqlx.Expect::Open([+no_error])</div><div class="line">Mysqlx.Crud::PrepareFind(stmt_id=1, ...) // may fail</div><div class="line">Mysqlx.Expect::Open([+no_error])</div><div class="line">Mysqlx.PreparedStmt::Execute(stmt_id=1, ...) // expectation(no_error) failed</div><div class="line">Mysqlx.Expect::Close()</div><div class="line">Mysqlx.PreparedStmt::Close(stmt_id=1) // expectation(no_error) failed</div><div class="line">Mysqlx.Expect::Close()</div></div><!-- fragment --><p>With these expectations pipelined, the server will handle errors in a consistent, reliable way.</p>
<p>It also allows to express how a streaming insert would behave if one of the inserts fails (for example: duplicate key error, disk full, and so on):</p>
<p>Either fail at first error:</p>
<div class="fragment"><div class="line">Mysqlx.Expect::Open([+no_error])</div><div class="line">Mysqlx.Crud::PrepareInsert(stmt_id=1, ...) // ok</div><div class="line">Mysqlx.Expect::Open([+no_error])</div><div class="line">Mysqlx.PreparedStmt::Execute(stmt_id=1, ...) // ok</div><div class="line">Mysqlx.PreparedStmt::Execute(stmt_id=1, ...) // duplicate_key error</div><div class="line">Mysqlx.PreparedStmt::Execute(stmt_id=1, ...) // expectation(no_error) failed</div><div class="line">Mysqlx.PreparedStmt::Execute(stmt_id=1, ...) // expectation(no_error) failed</div><div class="line">Mysqlx.Expect::Close()</div><div class="line">Mysqlx.PreparedStmt::Close(stmt_id=1) // ok</div><div class="line">Mysqlx.Expect::Close()</div></div><!-- fragment --><p>Or ignore error and continue:</p>
<div class="fragment"><div class="line">Mysqlx.Expect::Open([+no_error])</div><div class="line">Mysqlx.Crud::PrepareInsert(stmt_id=1, ...) // ok</div><div class="line">Mysqlx.Expect::Open([-no_error])</div><div class="line">Mysqlx.PreparedStmt::Execute(stmt_id=1, ...) // ok</div><div class="line">Mysqlx.PreparedStmt::Execute(stmt_id=1, ...) // duplicate_key error</div><div class="line">Mysqlx.PreparedStmt::Execute(stmt_id=1, ...) // ok</div><div class="line">Mysqlx.PreparedStmt::Execute(stmt_id=1, ...) // ok</div><div class="line">Mysqlx.Expect::Close()</div><div class="line">Mysqlx.PreparedStmt::Close(stmt_id=1) // expectation(no_error) failed</div><div class="line">Mysqlx.Expect::Close()</div></div><!-- fragment --><h1><a class="anchor" id="expectations_Behavior"></a>
Behavior </h1>
<p>An Expectation Block:</p>
<ul>
<li>encloses client messages</li>
<li>has a Condition Set</li>
<li>has a parent Expectation Block</li>
<li>can inherit a Condition Set from the parent Expectation Block or start with a empty Condition Set</li>
<li>fails if one of the Conditions fails while the Block is started or active</li>
<li>fails if one of the Conditions isn't recognized or not valid</li>
</ul>
<p>A Condition Set:</p>
<ul>
<li>has a set of Conditions</li>
<li>allows to set/unset Conditions</li>
</ul>
<p>A Condition:</p>
<ul>
<li>has a key and value</li>
<li>key is integer</li>
<li>value format depends on the key</li>
</ul>
<p>If a Expectation Block fails, all following messages of the Expectation block are failing with:</p>
<ul>
<li>error-msg: <code>Expectation failed: %s</code></li>
<li>error-code: ...</li>
</ul>
<h1><a class="anchor" id="expectations_Conditions"></a>
Conditions </h1>
<dl class="section warning"><dt>Warning</dt><dd>The layout of conditions are subject to change:<ul>
<li>not all may be implemented yet</li>
<li>more conditions may be added</li>
</ul>
</dd></dl>
<table class="doxtable">
<tr>
<th>Condition </th><th>Key  </th></tr>
<tr>
<td><a class="el" href="mysqlx_protocol_expectations.html#expectations_no_error">no_error</a> </td><td>1 </td></tr>
<tr>
<td><a class="el" href="mysqlx_protocol_expectations.html#expectations_schema_version">schema_version</a> </td><td>2 </td></tr>
<tr>
<td><a class="el" href="mysqlx_protocol_expectations.html#expectations_gtid_executed_contains">gtid_executed_contains</a> </td><td>3 </td></tr>
<tr>
<td><a class="el" href="mysqlx_protocol_expectations.html#expectations_gtid_wait_less_than_ms">gtid_wait_less_than_ms</a> </td><td>4 </td></tr>
</table>
<h2><a class="anchor" id="expectations_no_error"></a>
no_error</h2>
<p>Fail all messages of the block after the first message returning an error.</p>
<p>Example:</p>
<div class="fragment"><div class="line">Mysqlx.Expect::Open([+no_error])</div><div class="line">Mysqlx.Expect::Close()</div></div><!-- fragment --><h2><a class="anchor" id="expectations_schema_version"></a>
schema_version</h2>
<p>Fail all messages of the block if the schema version for the collection doesn't match. (<em>not implemented</em>)</p>
<dl class="section note"><dt>Note</dt><dd>This is a used by the JSON schema support of the server to ensure client and server are in agreement of what schema version is current* as it is currently planned to enforce the checks on the client-side.</dd></dl>
<p>Example:</p>
<div class="fragment"><div class="line">Mysqlx.Expect::Open([+schema_version::`schema`.`collection` = 1])</div><div class="line">Mysqlx.Expect::Close()</div></div><!-- fragment --><h2><a class="anchor" id="expectations_gtid_executed_contains"></a>
gtid_executed_contains</h2>
<p>Fail all messages until the end of the block if the <code>@@gtid_executed</code> doesn't contain the set GTID. (<em>not implemented</em>)</p>
<dl class="section note"><dt>Note</dt><dd>Used by the <em>read-your-writes</em> to ensure another node is already up to date.</dd></dl>
<p>Example:</p>
<div class="fragment"><div class="line">Mysqlx.Expect::Open([+gtid_executed_contains = &quot;...&quot;])</div><div class="line">Mysqlx.Expect::Close()</div></div><!-- fragment --><h2><a class="anchor" id="expectations_gtid_wait_less_than_ms"></a>
gtid_wait_less_than_ms</h2>
<p>Used in combination with <a class="el" href="mysqlx_protocol_expectations.html#expectations_gtid_executed_contains">gtid_executed_contains</a> to wait that the node caught up. (<em>not implemented</em>)</p>
<p>Example:</p>
<div class="fragment"><div class="line">Mysqlx.Expect::Open([+gtid_wait_less_than_ms = 1000])</div><div class="line">Mysqlx.Expect::Close()</div></div><!-- fragment --><h2><a class="anchor" id="expectations_sql_stateless"></a>
sql_stateless</h2>
<p>Fail any message that executes stateful statements like:</p>
<ul>
<li>temporary tables</li>
<li>user variables</li>
<li>session variables</li>
<li>stateful functions (<code>INSERT_ID()</code>, <code>GET_LOCK()</code>)</li>
<li>stateful language features (<code>SQL_CALC_FOUND_ROWS</code>)</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>Depending on the implementation stored procedures may be not allowed as they may through levels of indirection use stateful SQL features. </dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="mysqlx_protocol.html">X %Protocol</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
