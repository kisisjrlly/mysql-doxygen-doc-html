<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MySQL: sql/server_component/log_sink_perfschema.cc File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="mysql.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo-mysql-110x55.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MySQL
   &#160;<span id="projectnumber">8.0.22</span>
   </div>
   <div id="projectbrief">Source Code Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('log__sink__perfschema_8cc.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">log_sink_perfschema.cc File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>This file contains.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="sql_2server__component_2log__sink__perfschema_8h_source.html">log_sink_perfschema.h</a>&quot;</code><br />
<code>#include &lt;<a class="el" href="log__shared_8h_source.html">mysql/components/services/log_shared.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="string_8h_source.html">string.h</a>&gt;</code><br />
<code>#include &quot;<a class="el" href="log__builtins__internal_8h_source.html">log_builtins_internal.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="log__sink__perfschema__imp_8h_source.html">log_sink_perfschema_imp.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="log__sink__trad_8h_source.html">log_sink_trad.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="my__dir_8h_source.html">my_dir.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="my__loglevel_8h_source.html">my_loglevel.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="my__systime_8h_source.html">my_systime.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="log__builtins_8h_source.html">mysql/components/services/log_builtins.h</a>&quot;</code><br />
<code>#include &quot;mysqld_error.h&quot;</code><br />
<code>#include &quot;<a class="el" href="mysys__err_8h_source.html">mysys_err.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="log_8h_source.html">sql/log.h</a>&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:aaf4a03652ec08b10537a7e979c9939c6"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#aaf4a03652ec08b10537a7e979c9939c6">LOG_ERR_READ_LINE_SIZE</a>&#160;&#160;&#160;(<a class="el" href="log__shared_8h.html#a515e9f1c240b056be3ecdb0e73caa053">LOG_BUFF_MAX</a> * 2)</td></tr>
<tr class="separator:aaf4a03652ec08b10537a7e979c9939c6"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a85dd1cdae8a5a88a0b1f1657fb00bb53"><td class="memItemLeft" align="right" valign="top">static size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#a85dd1cdae8a5a88a0b1f1657fb00bb53">log_sink_pfs_event_size</a> (<a class="el" href="sql_2server__component_2log__sink__perfschema_8h.html#ab8b7fe57d7cf2ee022cd07f6af5133d1">log_sink_pfs_event</a> *e)</td></tr>
<tr class="memdesc:a85dd1cdae8a5a88a0b1f1657fb00bb53"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculate the size of the given event (header + blob + '\0' + alignment).  <a href="#a85dd1cdae8a5a88a0b1f1657fb00bb53">More...</a><br /></td></tr>
<tr class="separator:a85dd1cdae8a5a88a0b1f1657fb00bb53"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adc4bfb3bef7309eefe01ec6ca12f1eb0"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#adc4bfb3bef7309eefe01ec6ca12f1eb0">log_sink_pfs_event_header_fits</a> (char *<a class="el" href="ctype-mb_8cc.html#a6bc6b007533335efe02bafff799ec64c">p</a>)</td></tr>
<tr class="memdesc:adc4bfb3bef7309eefe01ec6ca12f1eb0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Test whether we're so close to the end of the ring-buffer that another event header would not fit.  <a href="#adc4bfb3bef7309eefe01ec6ca12f1eb0">More...</a><br /></td></tr>
<tr class="separator:adc4bfb3bef7309eefe01ec6ca12f1eb0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abf1f68911a2428aac55296c72e89e1c2"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#abf1f68911a2428aac55296c72e89e1c2">log_sink_pfs_read_start</a> ()</td></tr>
<tr class="memdesc:abf1f68911a2428aac55296c72e89e1c2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Acquire a read-lock on the ring-buffer.  <a href="#abf1f68911a2428aac55296c72e89e1c2">More...</a><br /></td></tr>
<tr class="separator:abf1f68911a2428aac55296c72e89e1c2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7eab702b4404ad96b099d05ce679c741"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#a7eab702b4404ad96b099d05ce679c741">log_sink_pfs_read_end</a> ()</td></tr>
<tr class="memdesc:a7eab702b4404ad96b099d05ce679c741"><td class="mdescLeft">&#160;</td><td class="mdescRight">Release read-lock on ring-buffer.  <a href="#a7eab702b4404ad96b099d05ce679c741">More...</a><br /></td></tr>
<tr class="separator:a7eab702b4404ad96b099d05ce679c741"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abfaf0693b985ff1a1807ae00b5a72240"><td class="memItemLeft" align="right" valign="top">size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#abfaf0693b985ff1a1807ae00b5a72240">log_sink_pfs_event_count</a> ()</td></tr>
<tr class="memdesc:abfaf0693b985ff1a1807ae00b5a72240"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get number of events currently in ring-buffer.  <a href="#abfaf0693b985ff1a1807ae00b5a72240">More...</a><br /></td></tr>
<tr class="separator:abfaf0693b985ff1a1807ae00b5a72240"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab53eb09536a80350811f6f5230ecd5d7"><td class="memItemLeft" align="right" valign="top"><a class="el" href="sql_2server__component_2log__sink__perfschema_8h.html#ab8b7fe57d7cf2ee022cd07f6af5133d1">log_sink_pfs_event</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#ab53eb09536a80350811f6f5230ecd5d7">log_sink_pfs_event_first</a> ()</td></tr>
<tr class="memdesc:ab53eb09536a80350811f6f5230ecd5d7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get oldest event still in ring-buffer.  <a href="#ab53eb09536a80350811f6f5230ecd5d7">More...</a><br /></td></tr>
<tr class="separator:ab53eb09536a80350811f6f5230ecd5d7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9fe7b57f498c03a8ddd81e3443e23449"><td class="memItemLeft" align="right" valign="top"><a class="el" href="sql_2server__component_2log__sink__perfschema_8h.html#ab8b7fe57d7cf2ee022cd07f6af5133d1">log_sink_pfs_event</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#a9fe7b57f498c03a8ddd81e3443e23449">log_sink_pfs_event_next</a> (<a class="el" href="sql_2server__component_2log__sink__perfschema_8h.html#ab8b7fe57d7cf2ee022cd07f6af5133d1">log_sink_pfs_event</a> *e)</td></tr>
<tr class="memdesc:a9fe7b57f498c03a8ddd81e3443e23449"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get event following the supplied one.  <a href="#a9fe7b57f498c03a8ddd81e3443e23449">More...</a><br /></td></tr>
<tr class="separator:a9fe7b57f498c03a8ddd81e3443e23449"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af9c7dacfa8528b5ca33bee4092dce911"><td class="memItemLeft" align="right" valign="top"><a class="el" href="sql_2server__component_2log__sink__perfschema_8h.html#ab8b7fe57d7cf2ee022cd07f6af5133d1">log_sink_pfs_event</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#af9c7dacfa8528b5ca33bee4092dce911">log_sink_pfs_event_valid</a> (<a class="el" href="sql_2server__component_2log__sink__perfschema_8h.html#ab8b7fe57d7cf2ee022cd07f6af5133d1">log_sink_pfs_event</a> *e, <a class="el" href="my__inttypes_8h.html#a22152088aba12c47e916b7f0ffee0f51">ulonglong</a> logged)</td></tr>
<tr class="memdesc:af9c7dacfa8528b5ca33bee4092dce911"><td class="mdescLeft">&#160;</td><td class="mdescRight">Use timestamp to check whether a given event-pointer still points to a valid event in the ring-buffer.  <a href="#af9c7dacfa8528b5ca33bee4092dce911">More...</a><br /></td></tr>
<tr class="separator:af9c7dacfa8528b5ca33bee4092dce911"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a352e166e174fe3887663980ea42f7b5e"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#a352e166e174fe3887663980ea42f7b5e">log_sink_pfs_event_expire</a> (void)</td></tr>
<tr class="separator:a352e166e174fe3887663980ea42f7b5e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6090b6fbbbe403b8df4e883bbd0d0be3"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#a6090b6fbbbe403b8df4e883bbd0d0be3">log_sink_pfs_write_wrap</a> (size_t s)</td></tr>
<tr class="memdesc:a6090b6fbbbe403b8df4e883bbd0d0be3"><td class="mdescLeft">&#160;</td><td class="mdescRight">If the current event can fit in the ring-buffer, but the write position is so close to the physical end of the ring-buffer that the event won't fit there, wrap to the beginning of the ring-buffer.  <a href="#a6090b6fbbbe403b8df4e883bbd0d0be3">More...</a><br /></td></tr>
<tr class="separator:a6090b6fbbbe403b8df4e883bbd0d0be3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2727c8eb023d8ec1071293ed14ae6fc9"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#a2727c8eb023d8ec1071293ed14ae6fc9">log_sink_pfs_sanitize_timestamp</a> (<a class="el" href="sql_2server__component_2log__sink__perfschema_8h.html#ab8b7fe57d7cf2ee022cd07f6af5133d1">log_sink_pfs_event</a> *e)</td></tr>
<tr class="separator:a2727c8eb023d8ec1071293ed14ae6fc9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a08cbbbd8a5605884faf120ffca5ac904"><td class="memItemLeft" align="right" valign="top"><a class="el" href="log__service_8h.html#ae4871f54cbb0619a0c304c2818298685">log_service_error</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#a08cbbbd8a5605884faf120ffca5ac904">log_sink_pfs_event_add</a> (<a class="el" href="sql_2server__component_2log__sink__perfschema_8h.html#ab8b7fe57d7cf2ee022cd07f6af5133d1">log_sink_pfs_event</a> *e, const char *blob_src)</td></tr>
<tr class="memdesc:a08cbbbd8a5605884faf120ffca5ac904"><td class="mdescLeft">&#160;</td><td class="mdescRight">Add a log-event to the ring buffer.  <a href="#a08cbbbd8a5605884faf120ffca5ac904">More...</a><br /></td></tr>
<tr class="separator:a08cbbbd8a5605884faf120ffca5ac904"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aeeed2c852b4f14483f634d4b5dc15c6c"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="log__service_8h.html#ae4871f54cbb0619a0c304c2818298685">log_service_error</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#aeeed2c852b4f14483f634d4b5dc15c6c">log_error_read_loop</a> (const char *<a class="el" href="mysqltest_8cc.html#a5aae0f6f4bc5268632a778e30168f402">log_file</a>, size_t size)</td></tr>
<tr class="memdesc:aeeed2c852b4f14483f634d4b5dc15c6c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Add all rows from a log file to the error-log ring-buffer.  <a href="#aeeed2c852b4f14483f634d4b5dc15c6c">More...</a><br /></td></tr>
<tr class="separator:aeeed2c852b4f14483f634d4b5dc15c6c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2a4fd23c87434111828aa9752a5bfbfa"><td class="memItemLeft" align="right" valign="top"><a class="el" href="log__service_8h.html#ae4871f54cbb0619a0c304c2818298685">log_service_error</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#a2a4fd23c87434111828aa9752a5bfbfa">log_error_read_log</a> (const char *log_name)</td></tr>
<tr class="memdesc:a2a4fd23c87434111828aa9752a5bfbfa"><td class="mdescLeft">&#160;</td><td class="mdescRight">Restore error log messages from previous shutdown.  <a href="#a2a4fd23c87434111828aa9752a5bfbfa">More...</a><br /></td></tr>
<tr class="separator:a2a4fd23c87434111828aa9752a5bfbfa"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab20616346d20473a4884c35288a71de9"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#ab20616346d20473a4884c35288a71de9">log_error_read_log_exit</a> ()</td></tr>
<tr class="memdesc:ab20616346d20473a4884c35288a71de9"><td class="mdescLeft">&#160;</td><td class="mdescRight">Release error log ring-buffer.  <a href="#ab20616346d20473a4884c35288a71de9">More...</a><br /></td></tr>
<tr class="separator:ab20616346d20473a4884c35288a71de9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a48e79e355c0f683d799a12840ae7c743"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#a48e79e355c0f683d799a12840ae7c743">log_error_read_log_init</a> ()</td></tr>
<tr class="memdesc:a48e79e355c0f683d799a12840ae7c743"><td class="mdescLeft">&#160;</td><td class="mdescRight">Set up ring-buffer for error-log.  <a href="#a48e79e355c0f683d799a12840ae7c743">More...</a><br /></td></tr>
<tr class="separator:a48e79e355c0f683d799a12840ae7c743"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af1f049b09d81331ce4a9dcee18f58269"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#af1f049b09d81331ce4a9dcee18f58269">log_sink_perfschema</a> (void *instance, <a class="el" href="log__shared_8h.html#abef61f7610a42c29cd8b3a92f391143f">log_line</a> *ll)</td></tr>
<tr class="memdesc:af1f049b09d81331ce4a9dcee18f58269"><td class="mdescLeft">&#160;</td><td class="mdescRight">services: log sinks: logging to performance_schema ring-buffer  <a href="#af1f049b09d81331ce4a9dcee18f58269">More...</a><br /></td></tr>
<tr class="separator:af1f049b09d81331ce4a9dcee18f58269"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:ad30e4b7d50cc3d5a8c95c0a1c8da3898"><td class="memItemLeft" align="right" valign="top">static const size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#ad30e4b7d50cc3d5a8c95c0a1c8da3898">ring_buffer_size</a> = 5 * 1024 * 1024</td></tr>
<tr class="memdesc:ad30e4b7d50cc3d5a8c95c0a1c8da3898"><td class="mdescLeft">&#160;</td><td class="mdescRight">In the interest of not adding more settings to confuse the using, the error-log ring-buffer is of a static size for now.  <a href="#ad30e4b7d50cc3d5a8c95c0a1c8da3898">More...</a><br /></td></tr>
<tr class="separator:ad30e4b7d50cc3d5a8c95c0a1c8da3898"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a726ff272d4ca37a9707aca60dd51e552"><td class="memItemLeft" align="right" valign="top">static char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#a726ff272d4ca37a9707aca60dd51e552">ring_buffer_start</a> = <a class="el" href="auth__ldap__sasl__client_8cc.html#ae7bd12bd7c9e418a420087971d0a7e31">nullptr</a></td></tr>
<tr class="separator:a726ff272d4ca37a9707aca60dd51e552"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5163479c858f8e2bedaced99576a9191"><td class="memItemLeft" align="right" valign="top">static char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#a5163479c858f8e2bedaced99576a9191">ring_buffer_end</a> = <a class="el" href="auth__ldap__sasl__client_8cc.html#ae7bd12bd7c9e418a420087971d0a7e31">nullptr</a></td></tr>
<tr class="separator:a5163479c858f8e2bedaced99576a9191"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa055ba14cda0443dccc421ecccb7db74"><td class="memItemLeft" align="right" valign="top">static char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#aa055ba14cda0443dccc421ecccb7db74">ring_buffer_write</a> = <a class="el" href="auth__ldap__sasl__client_8cc.html#ae7bd12bd7c9e418a420087971d0a7e31">nullptr</a></td></tr>
<tr class="separator:aa055ba14cda0443dccc421ecccb7db74"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4eaf3a9f39b51f7a8500ef17fa18597f"><td class="memItemLeft" align="right" valign="top">static char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#a4eaf3a9f39b51f7a8500ef17fa18597f">ring_buffer_read</a> = <a class="el" href="auth__ldap__sasl__client_8cc.html#ae7bd12bd7c9e418a420087971d0a7e31">nullptr</a></td></tr>
<tr class="separator:a4eaf3a9f39b51f7a8500ef17fa18597f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3780f414eb0dbc015e50faebdc66fb5f"><td class="memItemLeft" align="right" valign="top"><a class="el" href="my__inttypes_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#a3780f414eb0dbc015e50faebdc66fb5f">log_sink_pfs_buffered_bytes</a> = 0</td></tr>
<tr class="separator:a3780f414eb0dbc015e50faebdc66fb5f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae71af9b2c798b467abe2378c76eee39d"><td class="memItemLeft" align="right" valign="top"><a class="el" href="my__inttypes_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#ae71af9b2c798b467abe2378c76eee39d">log_sink_pfs_buffered_events</a> = 0</td></tr>
<tr class="separator:ae71af9b2c798b467abe2378c76eee39d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a771f46c65d936046af9e1c38b06b1ab6"><td class="memItemLeft" align="right" valign="top"><a class="el" href="my__inttypes_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#a771f46c65d936046af9e1c38b06b1ab6">log_sink_pfs_expired_events</a> = 0</td></tr>
<tr class="separator:a771f46c65d936046af9e1c38b06b1ab6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac4db6fba25f8830deebe4f4d898d3f71"><td class="memItemLeft" align="right" valign="top"><a class="el" href="my__inttypes_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#ac4db6fba25f8830deebe4f4d898d3f71">log_sink_pfs_longest_event</a> = 0</td></tr>
<tr class="separator:ac4db6fba25f8830deebe4f4d898d3f71"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a16c69b1e4a0c54098b41f916f474c33a"><td class="memItemLeft" align="right" valign="top"><a class="el" href="my__inttypes_8h.html#a22152088aba12c47e916b7f0ffee0f51">ulonglong</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#a16c69b1e4a0c54098b41f916f474c33a">log_sink_pfs_latest_timestamp</a> = 0</td></tr>
<tr class="separator:a16c69b1e4a0c54098b41f916f474c33a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af20d15138e9ec751cf6efa4575f7fa49"><td class="memItemLeft" align="right" valign="top"><a class="el" href="group__psi__abi__memory.html#ga902dd5c9fe51b8cbdd7438a30e43fdd0">PSI_memory_key</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#af20d15138e9ec751cf6efa4575f7fa49">key_memory_log_sink_pfs</a></td></tr>
<tr class="separator:af20d15138e9ec751cf6efa4575f7fa49"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7d47eb00cf6ec1a57c9fbea1fa747e7d"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="structmysql__rwlock__t.html">mysql_rwlock_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="log__sink__perfschema_8cc.html#a7d47eb00cf6ec1a57c9fbea1fa747e7d">THR_LOCK_log_perfschema</a></td></tr>
<tr class="memdesc:a7d47eb00cf6ec1a57c9fbea1fa747e7d"><td class="mdescLeft">&#160;</td><td class="mdescRight">ring-buffer rwlock Local to the sink that feeds the table performance_schema.error_log.  <a href="#a7d47eb00cf6ec1a57c9fbea1fa747e7d">More...</a><br /></td></tr>
<tr class="separator:a7d47eb00cf6ec1a57c9fbea1fa747e7d"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>This file contains. </p>
<p>a) the ring-buffer that stores a backlog of error-messages so they can be exposed to the SQL layer via performance_schema.error_log;</p>
<p>b) the log-sink that adds errors logged at run-time to the ring-buffer.</p>
<p>c) the error log reader that reads error log file at start-up (These functions will in turn use a parse-function defined in a log-sink. Whichever log-sink that has a parse-function is listed first in @global.log_error_services will be used; that service will decide what log-file to read (i.e. its name) and how to parse it. We initially support the reading of JSON- formatted error log files and of the traditional MySQL error log files.) This lets us restore error log information from previous runs when the server starts. These functions are called from mysqld.cc at start-up. </p>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a id="aaf4a03652ec08b10537a7e979c9939c6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aaf4a03652ec08b10537a7e979c9939c6">&#9670;&nbsp;</a></span>LOG_ERR_READ_LINE_SIZE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define LOG_ERR_READ_LINE_SIZE&#160;&#160;&#160;(<a class="el" href="log__shared_8h.html#a515e9f1c240b056be3ecdb0e73caa053">LOG_BUFF_MAX</a> * 2)</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="a2a4fd23c87434111828aa9752a5bfbfa"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2a4fd23c87434111828aa9752a5bfbfa">&#9670;&nbsp;</a></span>log_error_read_log()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="log__service_8h.html#ae4871f54cbb0619a0c304c2818298685">log_service_error</a> log_error_read_log </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>log_name</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Restore error log messages from previous shutdown. </p>
<p>We try restoring from the first (leftmost) of those services listed in @global.log_error_services that have the LOG_SERVICE_LOG_PARSER characteristic.</p>
<p>It is assumed that the last run's log file name is the same as the current one's. That is to say, we check whether the file supplied to &ndash;log-error already exists.</p>
<p>Once we have determined what file to read from, we'll call </p><dl class="section see"><dt>See also</dt><dd>log_error_read_loop() to do the actual reading and parsing.</dd></dl>
<p>It should be noted that at the point this function is normally called, buffered error logging will not have flushed yet.</p>
<p>a) If we are using the built-in "trad" sink/reader, the start-up messages are usually not buffered, and have already been written to the error log. In this case, they will be restored from the log (and flushing won't add another event to the ring-buffer).</p>
<p>b) If we are using a reader in a loadable log-service,</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">log_name</td><td>The log file to read (log_error_dest).</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">LOG_SERVICE_SUCCESS</td><td>Success (log read and parsed) </td></tr>
    <tr><td class="paramname">LOG_SERVICE_UNABLE_TO_READ</td><td>Could not read/access() file </td></tr>
    <tr><td class="paramname">LOG_SERVICE_INVALID_ARGUMENT</td><td>Invalid file-name (no '.') </td></tr>
    <tr><td class="paramname">LOG_SERVICE_NOT_AVAILABLE</td><td>No log_component active that can parse log-files </td></tr>
    <tr><td class="paramname">LOG_SERVICE_ARGUMENT_TOO_LONG</td><td>File-name too long </td></tr>
    <tr><td class="paramname">LOG_SERVICE_COULD_NOT_MAKE_LOG_NAME</td><td>Could not determine file extension </td></tr>
    <tr><td class="paramname">otherwise</td><td>Return value from reader </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="ab20616346d20473a4884c35288a71de9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab20616346d20473a4884c35288a71de9">&#9670;&nbsp;</a></span>log_error_read_log_exit()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int log_error_read_log_exit </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Release error log ring-buffer. </p>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">0</td><td>Success - buffer was released, or did not exist in the first place. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a48e79e355c0f683d799a12840ae7c743"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a48e79e355c0f683d799a12840ae7c743">&#9670;&nbsp;</a></span>log_error_read_log_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int log_error_read_log_init </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Set up ring-buffer for error-log. </p>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">0</td><td>Success - buffer was allocated. </td></tr>
    <tr><td class="paramname">!=0</td><td>Failure - buffer was not allocated. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="aeeed2c852b4f14483f634d4b5dc15c6c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aeeed2c852b4f14483f634d4b5dc15c6c">&#9670;&nbsp;</a></span>log_error_read_loop()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="log__service_8h.html#ae4871f54cbb0619a0c304c2818298685">log_service_error</a> log_error_read_loop </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>log_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Add all rows from a log file to the error-log ring-buffer. </p>
<p>We have to guesstimate where to start reading in the log:</p>
<ul>
<li>The error_log table is kept in a ring-buffer. Reading more items than we have space for is therefore harmless; we should however try to keep the waste down for performance reasons.</li>
<li>In the traditional log, the part of the row before the message is 63 characters long. This gets converted into an event header. The header's size is platform-dependent, but usually shorter than 63 bytes. Thus, the size of each record in the input will be more or less the size of its corresponding record in the output. As a consequence, reading the ring-buffer's size from the input should be about right.</li>
<li>When reading the JSON log, we'll fill in the event header from the parsed values, but we will also attach the entire JSON record to the event. Each record in the ring-buffer is therefore the size of the original JSON record, plus the size of a record header. As a consequence reading the ring-buffer's size from the input will give us more events than we need (because we "lose" about 50 bytes to the header for each event). However, the input is of variable length and we can not tell whether it's a few long rows or a lot of short ones. Therefore, we assume the worst (rather than the average) case and try to read input the size of the ring-buffer. This will mean that we read some more rows than we have space for, but since it's a ring-buffer, that means that the oldest entries will be discarded to make room for the younger ones, and we'll end up with the correct result.</li>
</ul>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">log_file</td><td>The file's name </td></tr>
    <tr><td class="paramname">size</td><td>length of the input file (in bytes)</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">LOG_SERVICE_SUCCESS</td><td>success </td></tr>
    <tr><td class="paramname">LOG_SERVICE_OPEN_FAILED</td><td>failed to open file </td></tr>
    <tr><td class="paramname">LOG_SERVICE_SEEK_FAILED</td><td>seek failed </td></tr>
    <tr><td class="paramname">LOG_SERVICE_UNABLE_TO_READ</td><td>read failed </td></tr>
    <tr><td class="paramname">LOG_SERVICE_PARSE_ERROR</td><td>could not find delimiter ('<br />
') </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="af1f049b09d81331ce4a9dcee18f58269"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af1f049b09d81331ce4a9dcee18f58269">&#9670;&nbsp;</a></span>log_sink_perfschema()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int log_sink_perfschema </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>instance</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="log__shared_8h.html#abef61f7610a42c29cd8b3a92f391143f">log_line</a> *&#160;</td>
          <td class="paramname"><em>ll</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>services: log sinks: logging to performance_schema ring-buffer </p>
<p>Will write timestamp, label, thread-ID, and message to stderr/file. If you should not be able to specify a label, one will be generated for you from the line's priority field.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">instance</td><td>instance handle </td></tr>
    <tr><td class="paramname">ll</td><td>the log line to write</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">int</td><td>number of added fields, if any </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a08cbbbd8a5605884faf120ffca5ac904"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a08cbbbd8a5605884faf120ffca5ac904">&#9670;&nbsp;</a></span>log_sink_pfs_event_add()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="log__service_8h.html#ae4871f54cbb0619a0c304c2818298685">log_service_error</a> log_sink_pfs_event_add </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="sql_2server__component_2log__sink__perfschema_8h.html#ab8b7fe57d7cf2ee022cd07f6af5133d1">log_sink_pfs_event</a> *&#160;</td>
          <td class="paramname"><em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>blob_src</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Add a log-event to the ring buffer. </p>
<p>In the ring-buffer, each event exists as a header and a blob. The header is a log_sink_pfs_event struct containing the traditional error-log columns. It is followed by a variable-length blob that contains just the message string in traditional log mode, and the complete event as JSON in JSON log format. The length of the event will be align to the correct boundary.</p>
<p>If writing the event would go past the end of the ring-buffer, we wrap around to the beginning of the buffer.</p>
<p>After the function success, <code>ring_buffer_read</code> will be set to a valid, non-zero value.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">e</td><td>filled-in event struct to copy into the ring-buffer </td></tr>
    <tr><td class="paramname">blob_src</td><td>variable-length part of the event to add to the ring-buffer</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">LOG_SERVICE_SUCCESS</td><td>event was added </td></tr>
    <tr><td class="paramname">LOG_SERVICE_NOT_AVAILABLE</td><td>ring-buffer not available </td></tr>
    <tr><td class="paramname">LOG_SERVICE_INVALID_ARGUMENT</td><td>event has no message </td></tr>
    <tr><td class="paramname">LOG_SERVICE_ARGUMENT_TOO_LONG</td><td>event is larger than buffer(!) </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="abfaf0693b985ff1a1807ae00b5a72240"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abfaf0693b985ff1a1807ae00b5a72240">&#9670;&nbsp;</a></span>log_sink_pfs_event_count()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">size_t log_sink_pfs_event_count </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Get number of events currently in ring-buffer. </p>
<p>Caller should hold THR_LOCK_log_perschema when reading this.</p>
<dl class="section return"><dt>Returns</dt><dd>number of events current in ring-buffer (0..) </dd></dl>

</div>
</div>
<a id="a352e166e174fe3887663980ea42f7b5e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a352e166e174fe3887663980ea42f7b5e">&#9670;&nbsp;</a></span>log_sink_pfs_event_expire()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void log_sink_pfs_event_expire </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<a id="ab53eb09536a80350811f6f5230ecd5d7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab53eb09536a80350811f6f5230ecd5d7">&#9670;&nbsp;</a></span>log_sink_pfs_event_first()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="sql_2server__component_2log__sink__perfschema_8h.html#ab8b7fe57d7cf2ee022cd07f6af5133d1">log_sink_pfs_event</a>* log_sink_pfs_event_first </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Get oldest event still in ring-buffer. </p>
<p>Caller should hold read-lock on THR_LOCK_log_perfschema when calling this.</p>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">nullptr</td><td>No events in buffer </td></tr>
    <tr><td class="paramname">otherwise</td><td>Address of oldest event in ring-buffer </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="adc4bfb3bef7309eefe01ec6ca12f1eb0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adc4bfb3bef7309eefe01ec6ca12f1eb0">&#9670;&nbsp;</a></span>log_sink_pfs_event_header_fits()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="innodb__memcache_2util-src_2config__parser_8c.html#abb452686968e48b67397da5f97445f5b">bool</a> log_sink_pfs_event_header_fits </td>
          <td>(</td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>p</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Test whether we're so close to the end of the ring-buffer that another event header would not fit. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">p</td><td>The address where we'd like to write (e.g. ring_buffer_write)</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">true</td><td>There is enough space to write a header. </td></tr>
    <tr><td class="paramname">false</td><td>Insufficient space, must wrap around to buffer-start to write. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a9fe7b57f498c03a8ddd81e3443e23449"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9fe7b57f498c03a8ddd81e3443e23449">&#9670;&nbsp;</a></span>log_sink_pfs_event_next()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="sql_2server__component_2log__sink__perfschema_8h.html#ab8b7fe57d7cf2ee022cd07f6af5133d1">log_sink_pfs_event</a>* log_sink_pfs_event_next </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="sql_2server__component_2log__sink__perfschema_8h.html#ab8b7fe57d7cf2ee022cd07f6af5133d1">log_sink_pfs_event</a> *&#160;</td>
          <td class="paramname"><em>e</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Get event following the supplied one. </p>
<p>Caller should hold read-lock on THR_LOCK_log_perfschema when calling this.</p>
<p>If advancing the read position puts the read-pointer beyond the highest-address event in the ring-buffer (which isn't necessarily the latest event, which is defined as the last event before catching up with the write-pointer), i.e. at a position where either a wrap- around marker exists, or there is not enough space for a header, we wrap around to the start of the ring-buffer.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">e</td><td>Last event the caller was processing. This event should be valid, non-NULL, and should not be a wrap-around marker (m_messages_length == 0).</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">nullptr</td><td>No more events in ring-buffer (caught up with writer) </td></tr>
    <tr><td class="paramname">otherwise</td><td>Address of the next event in the ring-buffer </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a85dd1cdae8a5a88a0b1f1657fb00bb53"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a85dd1cdae8a5a88a0b1f1657fb00bb53">&#9670;&nbsp;</a></span>log_sink_pfs_event_size()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static size_t log_sink_pfs_event_size </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="sql_2server__component_2log__sink__perfschema_8h.html#ab8b7fe57d7cf2ee022cd07f6af5133d1">log_sink_pfs_event</a> *&#160;</td>
          <td class="paramname"><em>e</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Calculate the size of the given event (header + blob + '\0' + alignment). </p>
<p>The header is followed by a blob (error message or JSON representation of the complete event) and a '\0' terminator (for safety); it is then aligned to the correct address boundary if needed.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">e</td><td>The event we're interested in. Must be non-NULL.</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">The</td><td>total size (header + message + '\0' + padding) in bytes. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="af9c7dacfa8528b5ca33bee4092dce911"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af9c7dacfa8528b5ca33bee4092dce911">&#9670;&nbsp;</a></span>log_sink_pfs_event_valid()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="sql_2server__component_2log__sink__perfschema_8h.html#ab8b7fe57d7cf2ee022cd07f6af5133d1">log_sink_pfs_event</a>* log_sink_pfs_event_valid </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="sql_2server__component_2log__sink__perfschema_8h.html#ab8b7fe57d7cf2ee022cd07f6af5133d1">log_sink_pfs_event</a> *&#160;</td>
          <td class="paramname"><em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="my__inttypes_8h.html#a22152088aba12c47e916b7f0ffee0f51">ulonglong</a>&#160;</td>
          <td class="paramname"><em>logged</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Use timestamp to check whether a given event-pointer still points to a valid event in the ring-buffer. </p>
<p>Caller should hold read-lock on THR_LOCK_log_perfschema when calling this.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">e</td><td>Address of event </td></tr>
    <tr><td class="paramname">logged</td><td>unique timestamp of event</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">nullptr</td><td>Event no longer exists in ring-buffer </td></tr>
    <tr><td class="paramname">otherwise</td><td>Address of the event in the ring-buffer </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a7eab702b4404ad96b099d05ce679c741"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7eab702b4404ad96b099d05ce679c741">&#9670;&nbsp;</a></span>log_sink_pfs_read_end()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void log_sink_pfs_read_end </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Release read-lock on ring-buffer. </p>

</div>
</div>
<a id="abf1f68911a2428aac55296c72e89e1c2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abf1f68911a2428aac55296c72e89e1c2">&#9670;&nbsp;</a></span>log_sink_pfs_read_start()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void log_sink_pfs_read_start </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Acquire a read-lock on the ring-buffer. </p>

</div>
</div>
<a id="a2727c8eb023d8ec1071293ed14ae6fc9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2727c8eb023d8ec1071293ed14ae6fc9">&#9670;&nbsp;</a></span>log_sink_pfs_sanitize_timestamp()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void log_sink_pfs_sanitize_timestamp </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="sql_2server__component_2log__sink__perfschema_8h.html#ab8b7fe57d7cf2ee022cd07f6af5133d1">log_sink_pfs_event</a> *&#160;</td>
          <td class="paramname"><em>e</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<a id="a6090b6fbbbe403b8df4e883bbd0d0be3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6090b6fbbbe403b8df4e883bbd0d0be3">&#9670;&nbsp;</a></span>log_sink_pfs_write_wrap()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int log_sink_pfs_write_wrap </td>
          <td>(</td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>s</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>If the current event can fit in the ring-buffer, but the write position is so close to the physical end of the ring-buffer that the event won't fit there, wrap to the beginning of the ring-buffer. </p>
<p>Write a wrap-marker if possible. Adjust the pointers as needed:</p>
<p>If there isn't enough space to write the current event (of size <code>s</code>): a) if the read-pointer &gt; write-pointer (which should always be the case after the first wrap), we wrap the read-pointer to the physical start of the ring-buffer b) write a wrap-marker if space permits c) wrap the write-pointer to the (physical) start of the ring-buffer</p>
<p>Caller must guarantee that event size &lt;= ring-buffer-size.</p>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">0</td><td>didn't need to wrap </td></tr>
    <tr><td class="paramname">1</td><td>write-pointer wrapped </td></tr>
    <tr><td class="paramname">2</td><td>write-pointer and read-pointer wrapped </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="af20d15138e9ec751cf6efa4575f7fa49"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af20d15138e9ec751cf6efa4575f7fa49">&#9670;&nbsp;</a></span>key_memory_log_sink_pfs</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="group__psi__abi__memory.html#ga902dd5c9fe51b8cbdd7438a30e43fdd0">PSI_memory_key</a> key_memory_log_sink_pfs</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a3780f414eb0dbc015e50faebdc66fb5f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3780f414eb0dbc015e50faebdc66fb5f">&#9670;&nbsp;</a></span>log_sink_pfs_buffered_bytes</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="my__inttypes_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a> log_sink_pfs_buffered_bytes = 0</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ae71af9b2c798b467abe2378c76eee39d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae71af9b2c798b467abe2378c76eee39d">&#9670;&nbsp;</a></span>log_sink_pfs_buffered_events</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="my__inttypes_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a> log_sink_pfs_buffered_events = 0</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a771f46c65d936046af9e1c38b06b1ab6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a771f46c65d936046af9e1c38b06b1ab6">&#9670;&nbsp;</a></span>log_sink_pfs_expired_events</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="my__inttypes_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a> log_sink_pfs_expired_events = 0</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a16c69b1e4a0c54098b41f916f474c33a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a16c69b1e4a0c54098b41f916f474c33a">&#9670;&nbsp;</a></span>log_sink_pfs_latest_timestamp</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="my__inttypes_8h.html#a22152088aba12c47e916b7f0ffee0f51">ulonglong</a> log_sink_pfs_latest_timestamp = 0</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ac4db6fba25f8830deebe4f4d898d3f71"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac4db6fba25f8830deebe4f4d898d3f71">&#9670;&nbsp;</a></span>log_sink_pfs_longest_event</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="my__inttypes_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a> log_sink_pfs_longest_event = 0</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a5163479c858f8e2bedaced99576a9191"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5163479c858f8e2bedaced99576a9191">&#9670;&nbsp;</a></span>ring_buffer_end</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">char* ring_buffer_end = <a class="el" href="auth__ldap__sasl__client_8cc.html#ae7bd12bd7c9e418a420087971d0a7e31">nullptr</a></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<a id="a4eaf3a9f39b51f7a8500ef17fa18597f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4eaf3a9f39b51f7a8500ef17fa18597f">&#9670;&nbsp;</a></span>ring_buffer_read</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">char* ring_buffer_read = <a class="el" href="auth__ldap__sasl__client_8cc.html#ae7bd12bd7c9e418a420087971d0a7e31">nullptr</a></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<a id="ad30e4b7d50cc3d5a8c95c0a1c8da3898"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad30e4b7d50cc3d5a8c95c0a1c8da3898">&#9670;&nbsp;</a></span>ring_buffer_size</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">const size_t ring_buffer_size = 5 * 1024 * 1024</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>In the interest of not adding more settings to confuse the using, the error-log ring-buffer is of a static size for now. </p>
<p>This will be easy enough to change later if needs or policy change.</p>
<p>While a log-event can currently be up to 8 KB in size (and with minor changes be of practically arbitrary size), a majority of common events seem to be in the 150 - 200 bytes range (in trad mode, perhaps 100 more each in JSON mode) at the time of this writing. That lead us to expect a yield of 4-6 events per KB, and thus about 25,000 for a buffer of 5 MB. </p>

</div>
</div>
<a id="a726ff272d4ca37a9707aca60dd51e552"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a726ff272d4ca37a9707aca60dd51e552">&#9670;&nbsp;</a></span>ring_buffer_start</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">char* ring_buffer_start = <a class="el" href="auth__ldap__sasl__client_8cc.html#ae7bd12bd7c9e418a420087971d0a7e31">nullptr</a></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<a id="aa055ba14cda0443dccc421ecccb7db74"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa055ba14cda0443dccc421ecccb7db74">&#9670;&nbsp;</a></span>ring_buffer_write</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">char* ring_buffer_write = <a class="el" href="auth__ldap__sasl__client_8cc.html#ae7bd12bd7c9e418a420087971d0a7e31">nullptr</a></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<a id="a7d47eb00cf6ec1a57c9fbea1fa747e7d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7d47eb00cf6ec1a57c9fbea1fa747e7d">&#9670;&nbsp;</a></span>THR_LOCK_log_perfschema</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structmysql__rwlock__t.html">mysql_rwlock_t</a> THR_LOCK_log_perfschema</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>ring-buffer rwlock Local to the sink that feeds the table performance_schema.error_log. </p>
<p>Code outside of the sink can acquire / release this lock using log_sink_pfs_read_start() / log_sink_pfs_read_start(). </p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_5bd71961b401a432086d0fb290a87f3f.html">sql</a></li><li class="navelem"><a class="el" href="dir_12a5ab756a4de267189eabf05ec2ce08.html">server_component</a></li><li class="navelem"><a class="el" href="log__sink__perfschema_8cc.html">log_sink_perfschema.cc</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
