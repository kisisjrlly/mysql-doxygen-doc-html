<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MySQL: MySQL Server Mock</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="mysql.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo-mysql-110x55.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MySQL
   &#160;<span id="projectnumber">8.0.22</span>
   </div>
   <div id="projectbrief">Source Code Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('PAGE_MYSQL_SERVER_MOCK.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">MySQL Server Mock </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The MySQL Server Mock</p>
<ul>
<li>speaks (a subset of) the MySQL Client/Server protocol</li>
<li>knows how to<ul>
<li>authenticate</li>
<li>respond to statements send by the client with<ul>
<li>resultsets</li>
<li>status (Ok, last-insert-id, ...)</li>
<li>Error</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>It reads the protocol trace from a JSON file which contains:</p>
<ul>
<li>sequence of statements to expect</li>
<li>responses to send</li>
<li>extra context information like execution-times</li>
</ul>
<h2>Motivation</h2>
<h3>Testing in isolation</h3>
<p>Testing MySQL InnoDB Cluster components like</p>
<ul>
<li>MySQL Shell</li>
<li>MySQL Router</li>
<li>Connectors</li>
</ul>
<p>involves:</p>
<ol type="1">
<li>initialize a MySQL Server via the MySQL Shell <code>dba.deploySandboxInstance</code><ul>
<li>which runs <code>mysqld --initialize</code></li>
</ul>
</li>
<li><p class="startli">use the MySQL Shell to</p><ul>
<li>builds a cluster with <code>dba.createCluster</code></li>
<li>add more nodes with <code>cluster.addInstance</code></li>
</ul>
<p class="startli">(10-20 seconds).</p>
</li>
<li>execute the statements to test the right behaviour (100ms)</li>
<li>shut down the whole setup again (1s)</li>
</ol>
<p>The setup and shutdown costs (20s) outscale the actual test runtime (100ms) by a great margin.</p>
<h3>Mocking the MySQL Server</h3>
<p>On the other side all the components speak to the MySQL Server over the MySQL Protocol only. Statements are sent, responses are received. What the MySQL Server did inbetween to generate the response isn't visible from the outside.</p>
<p>There is no difference from the point of view of the clients if the response comes from a genuine MySQL Server or from another program that returns the same bytes over the wire.</p>
<h2>Simple Demo</h2>
<p>A simple trace-file:</p>
<div class="fragment"><div class="line">{&quot;stmts&quot;: [</div><div class="line">  {</div><div class="line">    &quot;stmt&quot;: &quot;select @@version_comment limit 1&quot;,</div><div class="line">    &quot;result&quot;: {</div><div class="line">      &quot;columns&quot;: [{</div><div class="line">        &quot;type&quot;: &quot;STRING&quot;,</div><div class="line">        &quot;name&quot;: &quot;@@version_comment&quot;</div><div class="line">      }],</div><div class="line">      &quot;rows&quot;: [</div><div class="line">        [&quot;ImAMock&quot;]</div><div class="line">      ]}</div><div class="line">  },</div><div class="line">  {</div><div class="line">    &quot;stmt&quot;: &quot;select USER()&quot;,</div><div class="line">    &quot;result&quot;: {</div><div class="line">      &quot;columns&quot;: [{</div><div class="line">        &quot;type&quot;: &quot;STRING&quot;,</div><div class="line">        &quot;name&quot;: &quot;USER()&quot;</div><div class="line">      }],</div><div class="line">      &quot;rows&quot;: [</div><div class="line">        [&quot;mock&quot;]</div><div class="line">      ]</div><div class="line">    }</div><div class="line">  }]</div><div class="line">}</div></div><!-- fragment --><p>Starting the mock:</p>
<div class="fragment"><div class="line">$ ./mysql_server_mock ./simple.json 5500</div></div><!-- fragment --><p>Use a client to talk to the mock:</p>
<div class="fragment"><div class="line">$ mysql --port=5500</div><div class="line">Server version: 8.0.0-mock ImAMock</div><div class="line"></div><div class="line">[...]</div><div class="line"></div><div class="line">mock@localhost:5500 (none)&gt;</div></div><!-- fragment --><h1>Design Goals</h1>
<h2>Allow Faster Testing</h2>
<p>When using a MySQL Server the execution time of a statement is driven by the system that is used (storage-io, network-io, cpu speed, ...).</p>
<p>In cases where the execution time doesn't affect the behaviour (timeout testing, ...) the test setup could pretend the system has zero latency (storage in RAM, super fast CPUs, local networks).</p>
<p>It would be required to:</p>
<ul>
<li>capture the statement exchanged between client and server</li>
<li>provide a MySQL Server mock which<ul>
<li>speaks the MySQL Protocol</li>
<li>listens on a TCP port</li>
<li>returns the predefined results depending on the statement as a MySQL Server would.</li>
</ul>
</li>
</ul>
<h2>More Error Cases</h2>
<p>By using the Server Mock it is easier to create error-cases that are hard to create in real setups:</p>
<ul>
<li>disk full</li>
<li>server dead</li>
<li>nodes out of sync</li>
<li>...</li>
</ul>
<h2>Less options for failure</h2>
<p>By using the MySQL Server Mock in the Router tests, the tests don't need the rely on installing</p>
<ul>
<li>MySQL Shell</li>
<li>MySQL Server</li>
</ul>
<p>which involves:</p>
<ul>
<li>ensure the right version</li>
<li>check they actually work on the target</li>
<li>using the right paths</li>
</ul>
<h1>MySQL Router Demo</h1>
<h2>Bootstrapping a router</h2>
<p>To bootstrap a router, the router expects to talk to a MySQL Server. It:</p>
<ul>
<li>logs in with <code>root</code> and some password</li>
<li>executes 15 statements</li>
<li>writes <code>mysqlrouter.conf</code></li>
</ul>
<p>Start the "MySQL Server" mock on port <code>5050</code> with the <code>bootstrapper.yaml</code> </p><pre class="fragment">$ ./mysql_server_mock --mysqld-port=5050 --stmt-file=./bootstrapper.yaml
</pre><p>Let the router do the bootstrap </p><pre class="fragment">$ mysqlrouter --bootstrap localhost:5050 -d router-conf
Bootstrapping MySQL Router instance at &lt;stripped&gt;/rounter-conf...
MySQL Router  has now been configured for the InnoDB cluster 'test'.

The following connection information can be used to connect to the cluster.

Classic MySQL protocol connections to cluster 'test':
- Read/Write Connections: localhost:6446
- Read/Only Connections: localhost:6447

X protocol connections to cluster 'test':
- Read/Write Connections: localhost:64460
- Read/Only Connections: localhost:64470
</pre><p>The mock will log: </p><pre class="fragment">2017-01-24 12:24:11,551 MAIN INFO: listening on 5050
2017-01-24 12:24:23,357 MAIN INFO: accepted connection from ('127.0.0.1', 38684)
2017-01-24 12:24:23,358 MAIN DEBUG: received: SELECT * FROM mysql_innodb_cluster_metadata.schema_version
2017-01-24 12:24:23,358 MAIN DEBUG: sending Result
2017-01-24 12:24:23,395 MAIN DEBUG: received: SELECT  ((SELECT count(*) FROM ...
</pre><p>After the bootstrap is finished the bootstrap-mysql-server-mock can be stopped.</p>
<h2>Running the router</h2>
<p>Using the bootstrapped config:</p>
<ul>
<li>the metadata store is expected on port <code>5500</code></li>
<li>the data store is expected on port <code>5100</code></li>
</ul>
<p>Start the metadata-store </p><pre class="fragment">$ ./mysql_server_mock --mysqld-port=5500 --stmt-file=./metadata-store.yaml
</pre><p>Start the data-store </p><pre class="fragment">$ ./mysql_server_mock --mysqld-port=5100 --stmt-file=./group-replication.yaml
</pre><p>Start the router </p><pre class="fragment">$ mysqlrouter --config router-conf/mysqlrouter.conf
</pre><p>The router log file says: </p><pre class="fragment">2017-01-24 12:28:30 INFO    [7fc57d7eb700] [routing:test_default_ro] started: listening on 0.0.0.0:6447; read-only
2017-01-24 12:28:30 INFO    [7fc57dfec700] Starting Metadata Cache
2017-01-24 12:28:30 INFO    [7fc57cfea700] [routing:test_default_rw] started: listening on 0.0.0.0:6446; read-write
2017-01-24 12:28:30 INFO    [7fc577fff700] [routing:test_default_x_rw] started: listening on 0.0.0.0:64460; read-write
2017-01-24 12:28:30 INFO    [7fc5747e9700] [routing:test_default_x_ro] started: listening on 0.0.0.0:64470; read-only
2017-01-24 12:28:30 INFO    [7fc57dfec700] Connected with metadata server running on 127.0.0.1:5500
2017-01-24 12:28:30 INFO    [7fc57dfec700] Changes detected in cluster 'test' after metadata refresh
2017-01-24 12:28:30 INFO    [7fc57dfec700] Metadata for cluster 'test' has 1 replicasets:
2017-01-24 12:28:30 INFO    [7fc57dfec700] 'default' (3 members, single-primary)
2017-01-24 12:28:30 INFO    [7fc57dfec700]     localhost:5100 / 50000 - role=HA mode=RW
2017-01-24 12:28:30 INFO    [7fc57dfec700]     localhost:5110 / 50100 - role=HA mode=RO
2017-01-24 12:28:30 INFO    [7fc57dfec700]     localhost:5120 / 50200 - role=HA mode=RO
2017-01-24 12:28:30 INFO    [7fc5757fa700] Connected with metadata server running on 127.0.0.1:5500
</pre><p>The <code>metadata-store</code> mock outputs: </p><pre class="fragment">2017-01-24 12:28:10,322 MAIN INFO: listening on 5500
2017-01-24 12:28:20,774 MAIN INFO: accepted connection from ('127.0.0.1', 53278)
2017-01-24 12:28:20,775 MAIN DEBUG: received: SELECT R.replicaset_name, I.mysql_server_uuid, H.location, I.addresses-&gt;&gt;'$.mysqlClassic', I.addresses-&gt;&gt;'$.mysqlX' FROM mysql_innodb_cluster_metadata.clusters AS F JOIN mysql_innodb_cluster_metadata.replicasets AS R ON F.cluster_id = R.cluster_id JOIN mysql_innodb_cluster_metadata.instances AS I ON R.replicaset_id = I.replicaset_id JOIN mysql_innodb_cluster_metadata.hosts AS H ON I.host_id = H.host_id WHERE F.cluster_name = 'test';
2017-01-24 12:28:20,775 MAIN DEBUG: sending Result
</pre><p>The <code>group-replication</code> mock outputs: </p><pre class="fragment">2017-01-24 12:28:27,851 MAIN INFO: listening on 5100
2017-01-24 12:28:30,755 MAIN INFO: accepted connection from ('127.0.0.1', 41520)
2017-01-24 12:28:30,755 MAIN DEBUG: received: show status like 'group_replication_primary_member'
2017-01-24 12:28:30,755 MAIN DEBUG: sending Result
2017-01-24 12:28:30,795 MAIN DEBUG: received: SELECT member_id, member_host, member_port, member_state, @@group_replication_single_primary_mode FROM performance_schema.replication_group_members WHERE channel_name = 'group_replication_applier'
2017-01-24 12:28:30,795 MAIN DEBUG: sending Result
2017-01-24 12:28:30,835 MAIN INFO: closed connection to ('127.0.0.1', 41520)
</pre><h2>Mock Configuration</h2>
<p>The behaviour of the <code>mysql_server_mock</code> is driven by</p>
<ul>
<li>JSON Tracefiles</li>
<li>Javascript files</li>
</ul>
<p>They describe what the mock shall respond with when it receives:</p>
<ul>
<li>a handshake</li>
<li>a sequence of statements</li>
</ul>
<h3>JSON Tracefiles</h3>
<p>The structure of the JSON Tracefiles is defined in JSON-schema and can be seen in the source at src/mock_server/src/mysql_server_mock_schema.js</p>
<h3>Javascript</h3>
<p>The Javascript backed files for the mock are more powerful then the static JSON Tracefiles as it:</p>
<ul>
<li>allows to interface with the REST API of the <code>mysql_server_mock</code></li>
<li>allows "stmts" to be handled at runtime via javascript functions </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="PAGE_SERVER_TOOLS.html">Server tools</a></li><li class="navelem"><a class="el" href="PAGE_MYSQL_ROUTER.html">MySQL Router</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
